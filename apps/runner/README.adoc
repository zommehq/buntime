= Buntime Runner
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

ifdef::env-github[]
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: âš ï¸
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
endif::[]

toc::[]

== VisÃ£o Geral

Worker pool runner para aplicaÃ§Ãµes Bun, projetado como engine para uma plataforma serverless.

=== Features

* **Worker Pool Management** - Spawning dinÃ¢mico, pool size configurÃ¡vel, lifecycle automÃ¡tico
* **Semantic Versioning** - Suporte a `app@1.0.0`, `app@1`, `app`
* **Plugin System** - Config JSONC, lifecycle hooks, ordenaÃ§Ã£o por prioridade
* **Auth** - Keycloak/OIDC/JWT (AuthN) + polÃ­ticas XACML (AuthZ)
* **Monitoring** - SSE, Prometheus, stats por worker

=== Tech Stack

Bun, Hono, Zod, quick-lru, semver

== Estrutura do Projeto

[source]
----
apps/runner/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # Entry point (Bun.serve)
â”‚   â”œâ”€â”€ app.ts            # Hono app (routes aggregator)
â”‚   â”œâ”€â”€ constants.ts      # Environment variables
â”‚   â”œâ”€â”€ libs/
â”‚   â”‚   â”œâ”€â”€ dir-info.ts   # Directory operations
â”‚   â”‚   â””â”€â”€ pool/         # Worker pool management
â”‚   â”‚       â”œâ”€â”€ pool.ts       # WorkerPool class & singleton
â”‚   â”‚       â”œâ”€â”€ instance.ts   # WorkerInstance lifecycle
â”‚   â”‚       â”œâ”€â”€ wrapper.ts    # Worker thread code
â”‚   â”‚       â”œâ”€â”€ config.ts     # Worker configuration
â”‚   â”‚       â”œâ”€â”€ metrics.ts    # Pool metrics
â”‚   â”‚       â”œâ”€â”€ types.ts      # Message types
â”‚   â”‚       â””â”€â”€ preloads/
â”‚   â”‚           â””â”€â”€ setup.ts  # Worker preload
â”‚   â”œâ”€â”€ plugins/
â”‚   â”‚   â”œâ”€â”€ loader.ts     # Plugin loader
â”‚   â”‚   â””â”€â”€ registry.ts   # Plugin registry
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ internal/     # /_/* routes
â”‚   â”‚   â””â”€â”€ worker.ts     # /:app/* routes
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ get-app-dir.ts
â”‚       â”œâ”€â”€ get-entrypoint.ts
â”‚       â””â”€â”€ serve-static.ts
----

== ConfiguraÃ§Ã£o

=== buntime.jsonc

[source,jsonc]
----
{
  "required": ["@buntime/plugin-metrics"],
  "plugins": [
    "@buntime/plugin-metrics",
    ["@buntime/plugin-authn", { "provider": "keycloak", ... }],
    ["@buntime/plugin-authz", { "store": "file", ... }]
  ]
}
----

=== worker.jsonc (por app)

[source,jsonc]
----
{
  "entrypoint": "public/index.html",
  "timeout": 30,
  "ttl": 60,
  "maxRequests": 1000,
  "idleTimeout": 60,
  "autoInstall": false,
  "lowMemory": false
}
----

[cols="1,1,1,2"]
|===
| OpÃ§Ã£o | Tipo | Default | DescriÃ§Ã£o

| `autoInstall`
| boolean
| false
| Executa `bun install` antes de iniciar worker

| `entrypoint`
| string
| auto
| Entrypoint da aplicaÃ§Ã£o

| `idleTimeout`
| number
| 60
| Threshold de idle (segundos)

| `lowMemory`
| boolean
| false
| Ativa modo low-memory

| `maxRequests`
| number
| 1000
| MÃ¡ximo de requests antes de reciclar

| `timeout`
| number
| 30
| Timeout de request (segundos)

| `ttl`
| number
| 0
| TTL do worker (0 = sem limite)
|===

== Rotas da API

=== Internal (`/_/*`)

* `GET /_/deployments` - Gerenciamento de deployments
* `GET /_/metrics` - MÃ©tricas do pool (JSON)
* `GET /_/sse` - Stream SSE
* `GET /_/stats` - Stats completos

=== Plugin (`/_/{name}/*`)

* `/_/plugin-metrics/prometheus`
* `/_/plugin-authn/well-known`
* `/_/plugin-authz/policies`

=== Worker (`/`)

* `ALL /:app` - Roteia para worker da app
* `ALL /:app/*` - Roteia paths aninhados

**ResoluÃ§Ã£o de VersÃ£o:**

* `/hello-api` â†’ VersÃ£o mais alta
* `/hello-api@1.0.0` â†’ VersÃ£o exata
* `/hello-api@1` â†’ Maior versÃ£o 1.x.x

== Scripts

[source,bash]
----
bun dev              # Watch mode
bun lint             # Format + type check
bun test             # Run tests
bun build            # Build runner
bun build:bin        # Compile to binary
----

== Arquitetura

=== Request Flow

[source]
----
Request â†’ Hono Router â†’ Route?
  â”œâ”€â”€ /_/* â†’ Internal Routes
  â”œâ”€â”€ /_/{plugin}/* â†’ Plugin Routes
  â””â”€â”€ /:app/* â†’ Worker Pool â†’ Worker Thread
----

=== PrincÃ­pios de Design

1. Main thread orquestra, nunca executa lÃ³gica de app
2. Workers provÃªem isolamento (crash nÃ£o afeta main)
3. Pipeline de plugins intercepta requests/responses

=== Worker Lifecycle

[source]
----
Creating â†’ Ready â†’ Active âŸ· Idle â†’ Terminated
----

== Componentes Principais

[cols="1,2"]
|===
| Componente | Responsabilidade

| `pool.ts`
| Classe WorkerPool, LRU cache

| `instance.ts`
| Lifecycle do WorkerInstance

| `wrapper.ts`
| Request handling no worker

| `loader.ts`
| Carrega plugins do config

| `registry.ts`
| Lifecycle dos plugins
|===

include::docs/logging.adoc[leveloffset=+1]
