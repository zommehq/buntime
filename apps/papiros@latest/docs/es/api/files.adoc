== Endpoints de Archivos
:order: 2

=== Buscar Archivo Específico (Legado)

WARNING: Este endpoint se mantiene para compatibilidad retroactiva. Use `/api/projects/:project/docs/:slug` para nuevas implementaciones.

Retorna el contenido bruto de un archivo .adoc específico por ruta directa.

[source,http]
----
GET /api/projects/:project/files/:path?lang=es
----

**Parámetros:**

* `project` - Nombre del proyecto
* `path` - Ruta del archivo relativa a la carpeta de idioma (ej: `api/projects.adoc`)
* `lang` - Código de idioma (opcional, por defecto es `en`)

**Flujo:**

[mermaid]
----
sequenceDiagram
    participant C as Client
    participant A as API
    participant S as Security Check
    participant F as File System
    participant P as Parser

    C->>A: GET /api/projects/leaf/files/api/projects.adoc?lang=es
    A->>A: Build full path: content/leaf/es/api/projects.adoc
    A->>S: Validate path within content/
    alt Path invalid
        S-->>A: Security violation
        A-->>C: 400 Bad Request
    else Path valid
        S-->>A: Valid
        A->>F: Read file
        alt File not found
            F-->>A: Error
            A-->>C: 404 Not Found
        else File exists
            F-->>A: AsciiDoc content
            A->>P: Convert to HTML
            P-->>A: HTML + metadata
            A-->>C: JSON response
        end
    end
----

**Ejemplo:**

[source,bash]
----
curl "http://localhost:3000/api/projects/leaf/files/api/projects.adoc?lang=es"
----

**Respuesta:**

[source,json]
----
{
  "html": "<h2>Endpoints de Proyectos</h2>...",
  "lang": "es",
  "modifiedAt": "2025-12-20T10:30:00Z",
  "path": "api/projects.adoc"
}
----

=== Seguridad

El endpoint de archivos incluye medidas de seguridad para prevenir ataques de travesía de ruta:

[mermaid]
----
flowchart TD
    Request[File Request]
    BuildPath[Build Full Path]
    Check{Path starts with<br/>CONTENT_DIR?}
    Valid[Read File]
    Invalid[Return 400 Error]

    Request --> BuildPath
    BuildPath --> Check
    Check -->|Yes| Valid
    Check -->|No| Invalid

    style Invalid fill:#E74C3C
    style Valid fill:#7ED321
----

**Protegido contra:**

* Travesía de ruta: `../../../etc/passwd`
* Rutas absolutas: `/etc/passwd`
* Explotación de enlaces simbólicos

=== Errores Comunes

[cols="1,2,3"]
|===
| Código | Error | Causa

| 400
| Invalid path
| Intento de travesía de ruta o ruta fuera del directorio de contenido

| 404
| File not found
| El archivo no existe en la ruta especificada

| 404
| No documentation available
| La carpeta de idioma no existe para el proyecto
|===

=== Guía de Migración

Migre del endpoint legado `/files/` al endpoint moderno `/docs/`:

[cols="2,2"]
|===
| Legado (files) | Moderno (docs con slug)

| `/api/projects/leaf/files/api/projects.adoc`
| `/api/projects/leaf/docs/api/projects`

| Ruta de archivo directa requerida
| Slug amigable para SEO

| Sin mapeo de slug
| Resolución automática de slug

| Construcción manual de ruta
| Navegación jerárquica en árbol
|===

**Beneficios del endpoint `/docs/`:**

* URLs amigables para SEO
* Mapeo automático de slug
* Soporte para slugs personalizados vía atributo `:slug:`
* Mejor seguridad mediante validación de slug
* Detección de carpeta de timeline
