= Arquitectura
:order: 2

== Visión General

La Aplicación de Docs sigue la arquitectura estándar de buntime: un servidor Hono que sirve tanto la API como los assets estáticos del cliente React.

[mermaid]
----
graph TB
    Browser[Browser]
    Buntime[buntime Runtime]
    Static[Static Files Handler<br/>React Build]
    API[API Routes<br/>/api/*]
    Content[Content Files<br/>AsciiDoc]

    Browser --> Buntime
    Buntime --> Static
    Buntime --> API
    API --> Content

    style Browser fill:#e1f5ff
    style Buntime fill:#fff4e1
    style Static fill:#f0f0f0
    style API fill:#e8f5e9
    style Content fill:#fce4ec
----

== Componentes

=== Server (index.ts)

Entry point que configura:

* Rutas de la API (`/api/*`)
* Handler de archivos estáticos (cliente React)
* Hooks de lifecycle (`onIdle`, `onTerminate`)

[source,typescript]
----
export default {
  routes: { "/api/*": api.fetch },
  fetch: createStaticHandler(join(import.meta.dir, "client")),
};
----

=== API (server/api.ts)

Servidor Hono con endpoints REST:

* `GET /api/projects` - Lista proyectos
* `GET /api/projects/:project` - Obtener información del proyecto
* `GET /api/projects/:project/tree` - Árbol de archivos
* `GET /api/projects/:project/overview` - Visión general principal (index.adoc)
* `GET /api/projects/:project/docs/*` - Documento por slug
* `GET /api/projects/:project/releases/*` - Timeline de releases
* `GET /api/projects/:project/files/*` - Archivo específico (legado)
* `POST /api/cache/clear` - Limpiar cache

=== Client (client/)

Aplicación React con:

* TanStack Router - Enrutamiento basado en archivos
* TanStack Query - Obtención de datos y caché
* i18next - Internacionalización
* Radix UI - Componentes accesibles
* Tailwind CSS - Estilos

Componentes principales:

* `ProjectSwitcher` - Navegación entre proyectos
* `LanguageSwitcher` - Cambiar idioma
* `TocAside` - Navegación por índice
* `DocViewer` - Renderización de AsciiDoc
* `ReleaseTimeline` - Timeline de releases

== Arquitectura de Componentes

[mermaid]
----
graph TB
    subgraph Client["Capa Cliente"]
        Router[TanStack Router]
        Query[TanStack Query]
        Root[Root Layout]
        ProjectRoute[Project Route]
        DocViewer[Doc Viewer]
        Timeline[Release Timeline]
    end

    subgraph Server["Capa Servidor"]
        API[Hono API]
        Projects[Projects Router]
        Utils[Utils]
    end

    subgraph Storage["Capa de Almacenamiento"]
        Content[Content Files<br/>AsciiDoc]
    end

    Router --> Root
    Root --> ProjectRoute
    ProjectRoute --> DocViewer
    ProjectRoute --> Timeline

    Query --> API
    API --> Projects
    Projects --> Utils
    Utils --> Content

    style Client fill:#e3f2fd
    style Server fill:#f1f8e9
    style Storage fill:#fce4ec
----

== Flujo de Datos

[mermaid]
----
sequenceDiagram
    participant User
    participant Router
    participant Query
    participant API
    participant Content

    User->>Router: Navegar a /project/doc
    Router->>Query: Obtener documento
    Query->>API: GET /api/projects/:project/docs/*
    API->>Content: Leer archivo .adoc
    Content-->>API: Contenido del archivo
    API->>API: Convertir a HTML
    API-->>Query: Respuesta JSON
    Query-->>Router: Datos en caché
    Router->>User: Renderizar documento
----

== Tecnologías

[cols="1,2"]
|===
| Capa | Tecnología

| Runtime
| Bun + buntime

| Server
| Hono

| Client
| React 19

| Styling
| Tailwind CSS 4

| Build
| Bun bundler

| AsciiDoc
| asciidoctor.js
|===

== Estructura de Archivos

[mermaid]
----
graph TB
    subgraph Root["Raíz del Proyecto"]
        Entry[index.ts<br/>Entry Point]
        Config[Configuración<br/>package.json, tsconfig.json, bunfig.toml]
    end

    subgraph Server["Servidor"]
        ServerIndex[server/index.ts<br/>API Router]
        Routes[server/routes/<br/>projects.ts]
        Utils[server/utils/<br/>content, asciidoc, language, slug]
        Types[server/types.ts]
    end

    subgraph Client["Cliente"]
        ClientIndex[client/index.tsx<br/>React App]
        ClientRoutes[client/routes/<br/>TanStack Router]
        Components[client/components/<br/>Componentes UI]
        Hooks[client/hooks/<br/>Custom Hooks]
        Helpers[client/helpers/<br/>i18n, query-client]
    end

    subgraph Content["Contenido"]
        Projects[content/<br/>Proyectos]
        Locales[Docs Localizados<br/>en, pt, es]
        ADoc[Archivos AsciiDoc<br/>.adoc]
    end

    Entry --> ServerIndex
    Entry --> ClientIndex
    ServerIndex --> Routes
    Routes --> Utils
    ClientIndex --> ClientRoutes
    ClientRoutes --> Components
    Components --> Hooks
    ClientIndex --> Helpers
    Routes --> Projects
    Projects --> Locales
    Locales --> ADoc

    style Root fill:#fff4e1
    style Server fill:#e8f5e9
    style Client fill:#e3f2fd
    style Content fill:#fce4ec
----

== Estructura de Directorios

[source]
----
releases@latest/
├── index.ts                    # Entry point
├── package.json
├── tsconfig.json
├── bunfig.toml                 # Configuración de plugins Bun
├── server/
│   ├── index.ts                # Configuración de la API Hono
│   ├── types.ts                # Tipos TypeScript
│   ├── constants.ts            # Constantes
│   ├── routes/
│   │   └── projects.ts         # Endpoints de la API de proyectos
│   └── utils/
│       ├── content.ts          # Construcción de árbol, lectura de archivos
│       ├── asciidoc.ts         # Parsing de AsciiDoc
│       ├── language.ts         # Detección de idioma
│       └── slug.ts             # Generación de slug
├── client/
│   ├── index.html
│   ├── index.tsx               # Entry de la app React
│   ├── index.css               # Estilos globales
│   ├── routeTree.gen.ts        # Rutas generadas
│   ├── routes/
│   │   ├── __root.tsx          # Layout raíz
│   │   ├── index.tsx           # Página de inicio
│   │   ├── $project.tsx        # Layout del proyecto
│   │   └── $project/
│   │       └── $slug.tsx       # Visor de documentos
│   ├── components/
│   │   ├── doc-viewer.tsx      # Renderizador AsciiDoc
│   │   ├── project-switcher.tsx
│   │   ├── language-switcher.tsx
│   │   ├── toc-aside.tsx
│   │   ├── release-timeline.tsx
│   │   └── ui/                 # Componentes Radix UI
│   ├── hooks/
│   │   ├── use-project.ts
│   │   └── use-releases.ts
│   └── helpers/
│       ├── i18n.ts             # Configuración i18next
│       └── query-client.ts     # TanStack Query
├── content/                    # Contenido de la documentación
│   └── {project}/
│       ├── en/                 # Docs en inglés
│       ├── pt/                 # Docs en portugués
│       └── es/                 # Docs en español
└── scripts/
    └── build.ts                # Script de build
----
