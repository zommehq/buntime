= Visão Geral
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

Worker pool runner para aplicações Bun, projetado como engine para uma plataforma serverless.

== Features

* **Worker Pool Management** - Spawning dinâmico, pool size configurável, lifecycle automático
* **Semantic Versioning** - Suporte a `app@1.0.0`, `app@1`, `app@latest`
* **Plugin System** - Config JSONC, lifecycle hooks, ordenação topológica por dependências
* **Base Path Injection** - Suporte a SPAs sob subpaths via `<base href>`

== Plugins Disponíveis

O runtime auto-descobre plugins de `pluginDirs`. Plugins disponíveis:

[cols="1,2"]
|===
| Plugin | Descrição

| `@buntime/plugin-authn`
| Autenticação (Keycloak/OIDC/JWT, email-password)

| `@buntime/plugin-authz`
| Autorização com políticas XACML

| `@buntime/plugin-database`
| Adaptadores de banco (libsql, sqlite)

| `@buntime/plugin-deployments`
| Gerenciamento de apps (upload, download, exclusão)

| `@buntime/plugin-durable`
| Durable Objects (Cloudflare-like)

| `@buntime/plugin-gateway`
| Cache e rate limiting

| `@buntime/plugin-health`
| Health checks e probes Kubernetes

| `@buntime/plugin-keyval`
| Key-value store (Deno KV-like)

| `@buntime/plugin-logs`
| Logs em memória com SSE streaming

| `@buntime/plugin-metrics`
| Metricas Prometheus e SSE

| `@buntime/plugin-proxy`
| Proxy reverso com regras dinâmicas

| `@buntime/plugin-vhosts`
| Virtual hosts para multi-tenancy
|===

NOTE: Cada plugin tem seu próprio `manifest.jsonc` com a configuração. O estado enabled/disabled é controlado pelo database (`buntime.db`), não pelo manifest.

== Tech Stack

Bun, Hono, Zod, quick-lru, semver

== Estrutura do Projeto

[source]
----
runtime/
├── src/
│   ├── index.ts          # Entry point (Bun.serve)
│   ├── api.ts            # Hono app (agregador de rotas)
│   ├── app.ts            # Lógica de resolução de requests
│   ├── config.ts         # Configuração do runtime
│   ├── constants.ts      # Constantes e variáveis de ambiente
│   ├── libs/
│   │   ├── database.ts   # SQLite database (buntime.db)
│   │   └── pool/         # Gerenciamento do worker pool
│   │       ├── pool.ts       # Classe WorkerPool, LRU cache
│   │       ├── instance.ts   # Lifecycle do WorkerInstance
│   │       ├── wrapper.ts    # Código executado no worker thread
│   │       ├── config.ts     # Configuração de workers
│   │       ├── metrics.ts    # Métricas do pool
│   │       ├── stats.ts      # Utilitários estatísticos
│   │       └── types.ts      # Tipos de mensagens
│   ├── plugins/
│   │   ├── builtin.ts    # Resolvers de plugins builtin
│   │   ├── loader.ts     # Carregamento de plugins
│   │   └── registry.ts   # Registry e lifecycle de plugins
│   ├── routes/
│   │   ├── apps-core.ts      # /api/core/apps (gerenciamento de apps)
│   │   ├── plugins-core.ts   # /api/core/plugins (gerenciamento de plugins)
│   │   ├── plugins-info.ts   # GET /api/plugins
│   │   └── worker.ts         # Rotas de apps
│   └── utils/
│       ├── get-app-dir.ts     # Resolução de versão de apps
│       ├── get-entrypoint.ts  # Detecção de entrypoint
│       ├── plugins.ts         # Utilitários de plugins
│       ├── request.ts         # Clonagem de body, rewrite de URL
│       └── serve-static.ts    # Serving de arquivos estáticos
└── package.json
----

== Scripts

[source,bash]
----
bun dev              # Watch mode com hot reload
bun lint             # Format + type check
bun test             # Run tests
bun build            # Build runtime
bun build:bin        # Compile to binary
bun build:types      # Build TypeScript types
----

== Arquitetura

== Request Flow

[source]
----
Request -> Hono Router -> Resolve?
  |-- CSRF Protection
  |-- App-Shell Mode (se configurado)
  |-- Plugin onRequest Hooks
  |-- /api/core/plugins -> Plugins Core API
  |-- /api/core/apps -> Apps Core API
  |-- /api/plugins -> Plugin Info API
  |-- Plugin server.fetch handlers
  |-- Plugin Routes (Hono)
  |-- Plugin Apps (via z-frame)
  +-- /:app/* -> Worker Pool -> Worker Thread
  +-- 404 com Shell (se configurado)
----

== Princípios de Design

. Main thread orquestra, nunca executa lógica de app
. Workers proveem isolamento (crash não afeta main)
. Pipeline de plugins intercepta requests/responses
. Base path injection permite SPAs sob subpaths
. Ordenação topológica garante dependências entre plugins

== Worker Lifecycle

[source]
----
Creating -> Ready -> Active <-> Idle -> Terminated
----

== Componentes Principais

[cols="1,2"]
|===
| Componente | Responsabilidade

| `src/index.ts`
| Entry point, Bun.serve, graceful shutdown

| `src/api.ts`
| Hono app, agregador de rotas

| `src/app.ts`
| Resolução de requests, plugin apps

| `src/config.ts`
| Configuração do runtime (variáveis de ambiente)

| `src/libs/database.ts`
| SQLite database para estado de plugins

| `src/libs/pool/pool.ts`
| Classe WorkerPool, LRU cache

| `src/libs/pool/instance.ts`
| Lifecycle do WorkerInstance

| `src/libs/pool/wrapper.ts`
| Request handling no worker, base injection

| `src/plugins/loader.ts`
| Carrega plugins do config

| `src/plugins/registry.ts`
| Lifecycle e hooks dos plugins
|===
