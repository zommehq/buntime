= Roteamento

O runtime implementa um sistema de roteamento em múltiplas camadas que combina rotas de plugins, APIs internas e aplicações worker.

== Arquitetura de Roteamento

Ordem de resolução de rotas (conforme implementado em `app.ts`):

1. **CSRF Protection** - Validação de Origin para requisições state-changing (POST, PUT, PATCH, DELETE)
2. **App-Shell Mode** - Intercepta navegação para shell se configurado (ver <<shell-routing>>)
3. **Plugin onRequest Hooks** - Executa hooks de autenticação e pré-processamento
4. **Runtime APIs** - `/api/*` (plugins, apps, config, health, keys, docs)
5. **Plugin server.fetch** - Handlers de requisição de plugins com `server.fetch`
6. **Plugin Routes** - Rotas Hono montadas por plugins (ex: `/keyval/*`, `/metrics/*`)
7. **Plugin Apps** - Apps de plugins servidos via worker pool (z-frame iframes)
8. **Worker Routes** - Apps nos workerDirs (ex: `/my-app/*`)
9. **404 with Shell** - Fallback para shell exibir página 404 consistente

NOTE: A ordem de prioridade garante que rotas mais específicas (plugins) sejam resolvidas antes de rotas genéricas (workers). Plugin Routes são ordenados por especificidade (paths mais longos primeiro).

[[shell-routing]]
== Shell Routing

A função `shouldRouteToShell()` determina se uma requisição deve ser interceptada pelo app-shell:

[cols="1,2"]
|===
| Condição | Comportamento

| `Sec-Fetch-Mode !== "navigate"`
| Rejeita - requests não-navegação (fetch, XMLHttpRequest) não são interceptados

| Path contém `/api/`
| Rejeita - rotas de API nunca vão para o shell

| Path é `/` ou vazio
| Aceita - homepage sempre vai para o shell

| Path corresponde a base de plugin
| Aceita - ex: `/metrics`, `/keyval/entries`
|===

O shell routing executa **após** os hooks `onRequest` dos plugins, permitindo que autenticação seja processada antes da decisão de roteamento.

== Fallback para Homepage

Quando uma worker route retorna 404 e existe uma homepage configurada em modo inline (`base` definido), o runtime tenta servir o recurso a partir do app homepage:

[source]
----
GET /unknown-app/chunk-abc.js
  1. Worker route retorna 404
  2. Se homepage = { app: "/cpanel", base: "/" }
  3. Tenta buscar /cpanel/chunk-abc.js
  4. Se encontrado, retorna o asset
----

Isso permite que SPAs servidas na raiz carreguem assets corretamente mesmo quando acessadas por paths que não correspondem a apps específicos.

== Worker Apps

O runtime suporta aplicações worker com versionamento semântico e descoberta automática.

=== Formato de Diretórios

O runtime suporta dois formatos de diretório:

Flat (app@version):

[source]
----
apps/
  my-app@1.0.0/
  my-app@1.0.1/
  my-app@2.0.0/
----

Nested (app/version):

[source]
----
apps/
  my-app/
    1.0.0/
    1.0.1/
    2.0.0/
----

=== Resolução de Versões

O runtime usa semver para encontrar a versão correta:

[cols="1,2,2"]
|===
| Request | Descrição | Resolve para

| `/my-app/*`
| Versão mais recente
| `2.0.0`

| `/my-app@1/*`
| Versão mais recente 1.x.x
| `1.0.1`

| `/my-app@1.0/*`
| Versão mais recente 1.0.x
| `1.0.1`

| `/my-app@1.0.0/*`
| Versão exata
| `1.0.0`

| `/my-app@^1.0.0/*`
| Range semver
| `1.0.1`

| `/my-app@latest/*`
| Tag especial latest
| Diretório `my-app@latest` ou `my-app/latest`
|===

NOTE: Quando nenhuma versão é especificada (`/my-app/*`), o runtime prefere `latest` se existir, caso contrário usa a maior versão semver.

=== Entrypoints

O runtime busca entrypoints nesta ordem de prioridade:

1. `index.html` (servido como SPA estático)
2. `index.ts` (worker JavaScript)
3. `index.js` (worker JavaScript)
4. `index.mjs` (worker JavaScript)

Entrypoints podem ser customizados em `manifest.jsonc`:

[source,jsonc]
----
// manifest.jsonc
{
  "entrypoint": "server.ts"
}
----

=== Processo de Resolução

1. Verifica se é plugin app (rotas registradas por plugins)
2. Resolve versão nos workerDirs usando semver
3. Carrega worker config (`manifest.jsonc`)
4. Encontra entrypoint (HTML ou TS/JS)
5. Cria/reutiliza worker do pool
6. Injeta header `x-base` com base path (`/my-app`)
7. Encaminha requisição

=== Headers Especiais

[cols="1,3"]
|===
| Header | Descrição

| `x-base`
| Base path injetado pelo runtime para assets (ex: `/my-app`)

| `x-buntime-internal`
| Marca request como interno (worker-to-runtime), bypassa CSRF

| `x-not-found`
| Indica que nenhum app foi encontrado, shell deve renderizar 404

| `x-request-id`
| ID único para correlação de requests (UUID)
|===

== Rota Fallback

A rota `GET /*` é o fallback quando nenhuma outra rota corresponde:

- Se `homepage` está configurado no runtime: roteia para app homepage
- Caso contrário: retorna texto `"Buntime v{version}"`

Exemplo com homepage:

[source,bash]
----
GET /
# Redireciona para homepage app configurado
----

Exemplo sem homepage:

[source,bash]
----
GET /
# Retorna: "Buntime v1.0.0"
----
