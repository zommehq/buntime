= Service API
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

Esta seção documenta a API TypeScript exposta para outros plugins e para a aplicação.

== DatabaseService

O serviço principal registrado no container de injeção de dependência como `"database"`.

[source,typescript]
----
type AdapterType = "libsql" | "mysql" | "postgres" | "sqlite";

interface DatabaseService {
  /**
   * Obtém um adapter para um tipo e tenant específicos.
   * @param type - Tipo do adapter (usa default se não especificado)
   * @param tenantId - ID do tenant (usa root adapter se não especificado)
   */
  getAdapter(type?: AdapterType, tenantId?: string): Promise<DatabaseAdapter>;

  /**
   * Obtém o adapter root (sem isolamento de tenant).
   * @param type - Tipo do adapter (usa default se não especificado)
   */
  getRootAdapter(type?: AdapterType): DatabaseAdapter;

  /**
   * Retorna o tipo do adapter default.
   */
  getDefaultType(): AdapterType;

  /**
   * Retorna todos os tipos de adapters disponíveis.
   */
  getAvailableTypes(): AdapterType[];

  // Gerenciamento de tenants
  createTenant(tenantId: string, type?: AdapterType): Promise<void>;
  deleteTenant(tenantId: string, type?: AdapterType): Promise<void>;
  listTenants(type?: AdapterType): Promise<string[]>;
}
----

=== Resolução de Adapter

O parâmetro `type` é opcional em todos os métodos:

- Se não especificado, usa o adapter marcado como `default: true`
- Se nenhum adapter tem `default: true`, o primeiro adapter da lista é usado
- Se o tipo especificado não existir, lança um erro

== DatabaseAdapter

Interface unificada para execução de operações no banco de dados.

[source,typescript]
----
interface DatabaseAdapter {
  readonly type: AdapterType; // 'libsql' | 'postgres' | 'mysql' | 'sqlite'
  readonly tenantId: string | null;

  /**
   * Executa uma query SQL e retorna todas as linhas.
   */
  execute<T>(sql: string, args?: unknown[]): Promise<T[]>;

  /**
   * Executa uma query SQL e retorna a primeira linha ou null.
   */
  executeOne<T>(sql: string, args?: unknown[]): Promise<T | null>;

  /**
   * Executa múltiplos statements em batch (útil para libSQL).
   */
  batch(statements: Statement[]): Promise<void>;

  /**
   * Executa uma função dentro de uma transação.
   */
  transaction<T>(fn: (tx: TransactionAdapter) => Promise<T>): Promise<T>;
}
----

== Exemplos de Uso

=== Adapter Default

Exemplo de como consumir o serviço usando o adapter default:

[source,typescript]
----
export default function myPlugin(): BuntimePlugin {
  return {
    name: "my-plugin",

    async onInit(ctx: PluginContext) {
      // 1. Obter o serviço
      const dbService = ctx.getService<DatabaseService>("database");

      // 2. Obter adapter root (usa default)
      const adapter = dbService.getRootAdapter();

      // 3. Executar queries
      const users = await adapter.execute(
        "SELECT * FROM users WHERE active = ?",
        [true]
      );

      console.log(users);
    }
  };
}
----

=== Adapter Específico

Exemplo de como consumir um tipo específico de adapter:

[source,typescript]
----
export default function myPlugin(): BuntimePlugin {
  return {
    name: "my-plugin",

    async onInit(ctx: PluginContext) {
      const dbService = ctx.getService<DatabaseService>("database");

      // Usar libsql para cache
      const cacheAdapter = dbService.getRootAdapter("libsql");

      // Usar sqlite para dados locais
      const localAdapter = dbService.getRootAdapter("sqlite");

      // Listar adapters disponíveis
      const types = dbService.getAvailableTypes(); // ["libsql", "sqlite"]
      const defaultType = dbService.getDefaultType(); // "libsql"
    }
  };
}
----

=== Com Multi-Tenancy

Exemplo com isolamento de tenant:

[source,typescript]
----
async function handleRequest(ctx: PluginContext, tenantId: string) {
  const dbService = ctx.getService<DatabaseService>("database");

  // Obter adapter para um tenant específico (usa default type)
  const tenantAdapter = await dbService.getAdapter(undefined, tenantId);

  // Ou especificar o tipo
  const libsqlTenant = await dbService.getAdapter("libsql", tenantId);

  // Executar queries isoladas por tenant
  const users = await tenantAdapter.execute("SELECT * FROM users");
}
----
