= Setup
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

== Instalação

[source,bash]
----
bun add @buntime/plugin-database
----

== Configuração

A configuração é feita através do arquivo `buntime.jsonc`.

=== Múltiplos Adapters

Permite que diferentes plugins usem diferentes bancos de dados:

[source,jsonc]
----
{
  "plugins": [
    ["@buntime/plugin-database", {
      "adapters": [
        { "type": "libsql", "default": true, "urls": ["http://localhost:8880"] },
        { "type": "sqlite", "url": "file:./auth.db" }
      ]
    }],
    ["@buntime/plugin-keyval", { "database": "libsql" }],
    ["@buntime/plugin-authn", { "database": "sqlite" }],
    "@buntime/plugin-durable"
  ]
}
----

- Cada tipo de adapter pode aparecer apenas uma vez
- Um adapter deve ter `default: true` (ou o primeiro será usado como default)
- Plugins que não especificam `database` usam o adapter default

=== Com Multi-Tenancy

[source,jsonc]
----
{
  "plugins": [
    ["@buntime/plugin-database", {
      "adapters": [
        {
          "type": "libsql",
          "default": true,
          "urls": ["${LIBSQL_URL_0}"],
          "authToken": "${LIBSQL_TOKEN}"
        }
      ],
      "tenancy": {
        "autoCreate": true,
        "maxTenants": 1000
      }
    }]
  ]
}
----

**Opções de tenancy:**

- `autoCreate`: Cria tenants automaticamente no primeiro acesso (padrão: `false`)
- `defaultTenant`: ID do tenant padrão quando nenhum header de tenant é fornecido (opcional)
- `enabled`: Habilita suporte a multi-tenancy (padrão: `false`)
- `header`: Nome do header HTTP usado para identificação do tenant (padrão: `"X-Tenant-ID"`)
- `maxTenants`: Número máximo de adapters de tenant cacheados por tipo (padrão: `1000`)
  - Usa `QuickLRU` para eviction automática do menos recentemente usado
  - Adapters evictados são fechados automaticamente

NOTE: A Admin API para gerenciamento de namespaces usa a mesma URL principal (`urls[0]`).

=== Com Replicação

==== Via Variáveis de Ambiente (recomendado)

[source,bash]
----
LIBSQL_URL_0=http://primary:8080     # Primary (obrigatório)
LIBSQL_URL_1=http://replica1:8080    # Replica 1 (opcional)
LIBSQL_URL_2=http://replica2:8080    # Replica 2 (opcional)
----

O plugin detecta automaticamente e distribui leituras entre as réplicas.

==== Via Configuração Explícita

[source,jsonc]
----
{
  "plugins": [
    ["@buntime/plugin-database", {
      "adapters": [
        {
          "type": "libsql",
          "default": true,
          "urls": [
            "http://primary:8080",
            "http://replica1:8080",
            "http://replica2:8080"
          ]
        }
      ]
    }]
  ]
}
----

- `urls[0]` = Primary (escritas + leituras)
- `urls[1..n]` = Réplicas (apenas leituras, round-robin)

NOTE: As duas formas podem ser combinadas. URLs de variáveis de ambiente são adicionadas às do JSON.

== Variáveis de Ambiente

As variáveis de ambiente podem ser referenciadas na configuração usando a sintaxe `${VAR_NAME}`.

=== libSQL

[source,bash]
----
# Databases (LIBSQL_URL_0 é o primary, demais são réplicas)
LIBSQL_URL_0=http://localhost:8880      # Primary (obrigatório)
LIBSQL_URL_1=http://replica1:8080       # Replica 1 (opcional)
LIBSQL_URL_2=http://replica2:8080       # Replica 2 (opcional)

# Autenticação (opcional)
LIBSQL_TOKEN=your-jwt-token
----

O plugin detecta automaticamente as URLs:

- `LIBSQL_URL_0` → Primary (escritas e leituras)
- `LIBSQL_URL_1`, `LIBSQL_URL_2`, ... → Réplicas (apenas leituras, round-robin)

=== PostgreSQL

[source,bash]
----
POSTGRES_URL=postgresql://user:pass@localhost:5432/db
----

=== MySQL

[source,bash]
----
MYSQL_URL=mysql://user:pass@localhost:3306/db
----
