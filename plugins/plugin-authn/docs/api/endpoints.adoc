== Endpoints da API

=== Resumo

[cols="1,2,3"]
|===
| Método | Endpoint | Descrição

| `GET`
| `/auth/api/providers`
| Retorna lista de provedores configurados

| `GET`
| `/auth/api/session`
| Retorna a sessão atual do usuário

| `GET`
| `/auth/api/logout`
| Logout com redirect (query param `redirect`)

| `POST`
| `/auth/api/logout`
| Logout via API (retorna JSON)

| `ALL`
| `/auth/api/auth/*`
| Endpoints do better-auth (OAuth callbacks, signin, etc.)

| `ALL`
| `/auth/api/scim/v2/*`
| Endpoints SCIM 2.0 (ver seção SCIM)
|===

=== Redirecionamento

==== GET /auth/api/

Endpoint raiz que redireciona baseado no status de autenticação.

**Comportamento:**

* Se autenticado: redireciona para `/`
* Se não autenticado: redireciona para `/auth/login`

Este endpoint é útil para verificar o status de autenticação via redirect.

=== Provedores

==== GET /auth/api/providers

Retorna lista de provedores configurados para exibição na página de login.

**Response:**

[source,json]
----
[
  {
    "displayName": "Email",
    "icon": "lucide:mail",
    "providerId": "email-password",
    "type": "email-password"
  },
  {
    "displayName": "Keycloak",
    "icon": "simple-icons:keycloak",
    "providerId": "keycloak",
    "type": "keycloak"
  }
]
----

=== Sessão

==== GET /auth/api/session

Retorna informações da sessão atual.

**Response (autenticado):**

[source,json]
----
{
  "session": {
    "id": "session-id",
    "userId": "user-id",
    "expiresAt": "2024-01-01T00:00:00.000Z",
    "token": "session-token",
    "ipAddress": "127.0.0.1",
    "userAgent": "Mozilla/5.0..."
  },
  "user": {
    "id": "user-id",
    "email": "user@example.com",
    "name": "User Name",
    "image": null,
    "emailVerified": true,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z",
    "active": true,
    "externalId": null,
    "roles": ["user"],
    "groups": ["developers"]
  }
}
----

**Response (não autenticado):**

[source,json]
----
{
  "session": null,
  "user": null
}
----

=== Logout

==== GET /auth/api/logout

Encerra a sessão e redireciona. Para provedores OIDC, redireciona primeiro para o endpoint de logout do provedor.

**Query params:**

* `redirect` - URL de redirecionamento após logout (default: `/`)

**Exemplo:**

[source,bash]
----
curl -X GET "http://localhost:8000/auth/api/logout?redirect=/login"
----

**Comportamento:**

. Obtém sessão atual
. Se usuário tem conta OIDC com `idToken`, obtém URL de logout do provedor
. Limpa sessão local (remove cookie)
. Redireciona para URL de logout do OIDC (se disponível) ou para `redirect`

==== POST /auth/api/logout

Encerra a sessão via API. Útil para SPAs que precisam controlar o redirect.

**Response:**

[source,json]
----
{
  "success": true,
  "oidcLogoutUrl": "https://keycloak.example.com/realms/buntime/protocol/openid-connect/logout?..."
}
----

O campo `oidcLogoutUrl` é retornado quando o usuário tem uma sessão OIDC ativa. Será `null` se o usuário não tiver uma conta OIDC vinculada. O client pode redirecionar para esta URL para completar o logout no provedor.

=== Fluxo OAuth

O fluxo de autenticação OAuth é gerenciado pelo better-auth:

. Usuário acessa rota protegida
. Redirecionado para `/auth/login`
. Seleciona provedor (ex: "Sign in with Keycloak")
. Redirecionado para provedor OIDC
. Após autenticação, redirecionado de volta com código
. better-auth troca código por tokens
. Sessão criada e cookie setado
. Usuário redirecionado para URL original

=== Schema de Usuário

O plugin estende o schema de usuário do better-auth com campos adicionais:

[cols="2,1,3"]
|===
| Campo | Tipo | Descrição

| `id`
| `string`
| ID único do usuário

| `email`
| `string`
| Email do usuário

| `name`
| `string`
| Nome de exibição

| `image`
| `string?`
| URL do avatar

| `emailVerified`
| `boolean`
| Email verificado

| `createdAt`
| `Date`
| Data de criação

| `updatedAt`
| `Date`
| Data de atualização

| `active`
| `boolean`
| Usuário ativo (para SCIM)

| `externalId`
| `string?`
| ID externo (para SCIM)

| `metadata`
| `object?`
| Metadados adicionais (JSON)

| `roles`
| `string[]`
| Roles do usuário

| `groups`
| `string[]`
| Grupos do usuário
|===
