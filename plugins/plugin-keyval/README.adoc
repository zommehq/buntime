= KeyVal Plugin
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

ifdef::env-github[]
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: âš ï¸
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
endif::[]

image:https://img.shields.io/badge/Bun-1.x-blue[Bun]
image:https://img.shields.io/badge/libSQL-latest-green[libSQL]
image:https://img.shields.io/badge/TypeScript-5.0+-blue[TypeScript]

toc::[]

== VisÃ£o Geral

**plugin-keyval** Ã© o plugin Buntime que expÃµe uma API REST para o KeyVal, um banco de dados key-value com API compatÃ­vel com Deno KV.

Para documentaÃ§Ã£o de uso do SDK, veja o pacote link:../../packages/keyval/README.adoc[@buntime/keyval].

== InstalaÃ§Ã£o

[source,bash]
----
# O plugin Ã© instalado junto com o Buntime
bun add @buntime/plugin-keyval
----

== ConfiguraÃ§Ã£o

=== buntime.jsonc

[source,jsonc]
----
{
  "plugins": [
    ["@buntime/plugin-keyval", {
      "libsqlUrl": "${LIBSQL_URL}",           // URL do servidor libSQL
      "libsqlReplicaUrl": "${LIBSQL_REPLICA_URL}", // URL da rÃ©plica (opcional)
      "libsqlToken": "${LIBSQL_TOKEN}",       // Token de autenticaÃ§Ã£o (opcional)
      "cleanupInterval": 60000,               // Intervalo de limpeza de expirados (ms)
      "operationTimeout": 30000               // Timeout de operaÃ§Ãµes (ms)
    }]
  ]
}
----

=== VariÃ¡veis de Ambiente

[source,bash]
----
# Desenvolvimento local
LIBSQL_URL=http://localhost:8880

# Com rÃ©plica
LIBSQL_REPLICA_URL=http://localhost:8882

# ProduÃ§Ã£o (libSQL self-hosted)
LIBSQL_URL=http://libsql:8080
LIBSQL_TOKEN=your-jwt-token
----

TIP: Para detalhes sobre autenticaÃ§Ã£o JWT e configuraÃ§Ã£o avanÃ§ada do sqld, consulte a https://github.com/tursodatabase/libsql/tree/main/docs[documentaÃ§Ã£o oficial do libSQL].

=== Docker Compose

[source,yaml]
----
services:
  libsql:
    image: ghcr.io/tursodatabase/libsql-server:latest
    ports:
      - "8880:8080"  # HTTP API
      - "8881:5001"  # gRPC (replicaÃ§Ã£o)
    environment:
      SQLD_NODE: primary
      SQLD_HTTP_LISTEN_ADDR: 0.0.0.0:8080
      SQLD_GRPC_LISTEN_ADDR: 0.0.0.0:5001
      SQLD_DISABLE_AUTH: "true"

  libsql-replica:
    image: ghcr.io/tursodatabase/libsql-server:latest
    ports:
      - "8882:8080"
    environment:
      SQLD_NODE: replica
      SQLD_PRIMARY_URL: http://libsql:5001
      SQLD_HTTP_LISTEN_ADDR: 0.0.0.0:8080
      SQLD_DISABLE_AUTH: "true"
    depends_on:
      - libsql
----

== Arquitetura

=== Componentes

[source]
----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AplicaÃ§Ã£o                            â”‚
â”‚                    (Worker/App Buntime)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   @buntime/keyval                           â”‚
â”‚                   (Cliente HTTP)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                @buntime/plugin-keyval                       â”‚
â”‚                   (Plugin Server)                           â”‚
â”‚   Rotas: /_/plugin-keyval/*                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ libSQL Protocol
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      libSQL Server                          â”‚
â”‚                  (SQLite distribuÃ­do)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

=== Schema do Banco

[source,sql]
----
-- Tabela de entradas KV
CREATE TABLE kv_entries (
  key BLOB PRIMARY KEY,        -- Chave codificada em bytes
  value BLOB NOT NULL,         -- Valor serializado em JSON
  versionstamp TEXT NOT NULL,  -- VersÃ£o para controle de concorrÃªncia
  expires_at INTEGER           -- Unix timestamp de expiraÃ§Ã£o (opcional)
);

CREATE INDEX idx_kv_expires ON kv_entries(expires_at)
  WHERE expires_at IS NOT NULL;

-- Tabela de fila de mensagens
CREATE TABLE kv_queue (
  id TEXT PRIMARY KEY,              -- UUID da mensagem
  value BLOB NOT NULL,              -- Payload serializado
  ready_at INTEGER NOT NULL,        -- Quando ficarÃ¡ disponÃ­vel
  attempts INTEGER DEFAULT 0,       -- Tentativas de entrega
  max_attempts INTEGER DEFAULT 5,   -- MÃ¡ximo de tentativas
  backoff_schedule TEXT,            -- JSON array de delays
  keys_if_undelivered TEXT,         -- Fallback keys
  status TEXT DEFAULT 'pending',    -- pending | processing | failed
  locked_until INTEGER,             -- Lock timestamp
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- Dead Letter Queue
CREATE TABLE kv_dlq (
  id TEXT PRIMARY KEY,
  original_id TEXT NOT NULL,
  value BLOB NOT NULL,
  error_message TEXT,
  attempts INTEGER NOT NULL,
  failed_at INTEGER NOT NULL
);
----

== Endpoints REST

=== Keys

[cols="1,2,2"]
|===
| MÃ©todo | Endpoint | DescriÃ§Ã£o

| GET
| `/keys/:key`
| Buscar uma chave

| POST
| `/keys/batch`
| Buscar mÃºltiplas chaves (get com array)

| PUT
| `/keys/:key`
| Criar/atualizar uma chave

| DELETE
| `/keys/:key`
| Deletar uma chave

| GET
| `/keys`
| Listar por prefixo

| DELETE
| `/keys`
| Deletar por prefixo

| POST
| `/keys/paginate`
| Listar com paginaÃ§Ã£o por cursor

| POST
| `/keys/count`
| Contar entradas por prefixo
|===

=== TransaÃ§Ãµes

[cols="1,2,2"]
|===
| MÃ©todo | Endpoint | DescriÃ§Ã£o

| POST
| `/atomic`
| Executar operaÃ§Ã£o atÃ´mica

| POST
| `/transaction`
| Executar transaÃ§Ã£o com snapshot
|===

=== Filas

[cols="1,2,2"]
|===
| MÃ©todo | Endpoint | DescriÃ§Ã£o

| POST
| `/queue/enqueue`
| Enfileirar mensagem

| GET
| `/queue/dequeue`
| Obter prÃ³xima mensagem

| POST
| `/queue/ack/:id`
| Confirmar processamento

| POST
| `/queue/nack/:id`
| Rejeitar mensagem (retry)

| GET
| `/queue/stats`
| EstatÃ­sticas da fila

| GET
| `/queue/listen`
| SSE para receber mensagens
|===

=== Dead Letter Queue

[cols="1,2,2"]
|===
| MÃ©todo | Endpoint | DescriÃ§Ã£o

| GET
| `/queue/dlq`
| Listar mensagens na DLQ

| GET
| `/queue/dlq/:id`
| Obter mensagem especÃ­fica

| POST
| `/queue/dlq/:id/requeue`
| Reprocessar mensagem

| DELETE
| `/queue/dlq/:id`
| Deletar mensagem

| DELETE
| `/queue/dlq`
| Limpar toda DLQ
|===

=== Watch

[cols="1,2,2"]
|===
| MÃ©todo | Endpoint | DescriÃ§Ã£o

| GET
| `/watch`
| SSE para observar chaves

| GET
| `/watch/poll`
| Polling para observar chaves

| GET
| `/watch/prefix`
| SSE para observar prefixo

| GET
| `/watch/prefix/poll`
| Polling para observar prefixo
|===

=== MÃ©tricas

[cols="1,2,2"]
|===
| MÃ©todo | Endpoint | DescriÃ§Ã£o

| GET
| `/metrics`
| MÃ©tricas em JSON

| GET
| `/metrics/prometheus`
| MÃ©tricas em formato Prometheus
|===

== Fundamentos

include::docs/fundamentals/architecture.adoc[leveloffset=+1]

include::docs/fundamentals/internals.adoc[leveloffset=+1]

include::docs/fundamentals/limitations.adoc[leveloffset=+1]

include::docs/fundamentals/decisions.adoc[leveloffset=+1]

include::docs/fundamentals/future.adoc[leveloffset=+1]

== API

include::docs/api/http-api-spec.adoc[leveloffset=+1]

include::docs/api/metrics.adoc[leveloffset=+1]

== Deploy e OperaÃ§Ãµes

include::docs/deployment/deployment.adoc[leveloffset=+1]

include::docs/deployment/security.adoc[leveloffset=+1]

include::docs/deployment/performance.adoc[leveloffset=+1]

include::docs/deployment/troubleshooting.adoc[leveloffset=+1]
