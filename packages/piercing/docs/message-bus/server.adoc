== Server Message Bus

O `ServerMessageBus` é a implementação do Message Bus para o lado servidor, com capacidades de serialização e integração com HTTP.

=== Criação

[source,typescript]
----
import { ServerMessageBus } from "@piercing/message-bus/server-message-bus";

// Com estado inicial vazio
const bus = new ServerMessageBus();

// Com estado inicial
const bus = new ServerMessageBus({
  theme: "dark",
  user: { id: "123" }
});
----

=== fromRequest()

Cria uma instância do ServerMessageBus a partir dos headers de uma requisição HTTP:

[source,typescript]
----
import { ServerMessageBus } from "@piercing/message-bus/server-message-bus";

export default {
  async fetch(request: Request) {
    const bus = ServerMessageBus.fromRequest(request);

    // Usar o bus com estado do cliente
    const theme = bus.latestValue("theme");

    return new Response("OK");
  }
};
----

O método lê o header `x-message-bus-state` e deserializa o estado. Se o header não existir ou for inválido, retorna uma instância com estado vazio.

=== toRequest()

Adiciona o estado do Message Bus aos headers de uma nova requisição:

[source,typescript]
----
const bus = new ServerMessageBus({ theme: "dark" });

// Criar requisição com estado do bus
const request = new Request("https://api.example.com/data");
const requestWithState = bus.toRequest(request);

// A nova requisição contém o header x-message-bus-state
await fetch(requestWithState);
----

Este método é útil para:

- Propagar estado entre microserviços
- Enviar contexto do servidor para workers
- Fazer requisições HTTP com contexto compartilhado

=== MESSAGE_BUS_STATE_HEADER

Constante que define o nome do header usado para transmitir estado:

[source,typescript]
----
import { MESSAGE_BUS_STATE_HEADER } from "@piercing/message-bus/server-message-bus";

console.log(MESSAGE_BUS_STATE_HEADER); // "x-message-bus-state"
----

=== serialize()

Serializa o estado atual do bus para JSON:

[source,typescript]
----
const bus = new ServerMessageBus();
bus.dispatch("counter", 42);

const json = bus.serialize();
console.log(json); // '{"counter":42}'
----

=== Exemplo Completo

[source,typescript]
----
import { ServerMessageBus } from "@piercing/message-bus/server-message-bus";

export default {
  async fetch(request: Request) {
    // Ler estado da requisição
    const bus = ServerMessageBus.fromRequest(request);

    // Adicionar dados do servidor
    bus.dispatch("server:time", Date.now());
    bus.dispatch("server:region", "us-east-1");

    // Fazer requisição para outro serviço com estado
    const apiRequest = new Request("https://api.internal/data");
    const response = await fetch(bus.toRequest(apiRequest));

    // Retornar HTML com estado injetado
    const html = `
      <!DOCTYPE html>
      <html>
        <head>
          <script>
            window.__PIERCING_MESSAGE_BUS_STATE__ = ${bus.serialize()};
          </script>
        </head>
        <body>...</body>
      </html>
    `;

    return new Response(html, {
      headers: { "Content-Type": "text/html" }
    });
  }
};
----

=== Tratamento de Erros

O método `fromRequest()` captura erros de parsing silenciosamente e retorna uma instância vazia em caso de falha:

[source,typescript]
----
// Header inválido ou corrompido
const request = new Request("https://example.com", {
  headers: { "x-message-bus-state": "invalid-json" }
});

const bus = ServerMessageBus.fromRequest(request);
// Retorna instância vazia, log de warning no console
----
