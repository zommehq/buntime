== Message Bus

O Message Bus é um sistema de comunicação isomórfico que permite troca de eventos e estado entre servidor e cliente em aplicações Piercing.

=== Conceitos Principais

==== Isomorfismo

O Message Bus funciona tanto no servidor quanto no cliente, usando a mesma API e estrutura de dados. A classe `GenericMessageBus` fornece a implementação base compartilhada por ambos os ambientes.

==== MessageBusState

O estado do Message Bus é um objeto simples que armazena os últimos valores de cada evento:

[source,typescript]
----
type MessageBusState = Record<string, JSONValue>;
----

Este estado pode ser serializado e transmitido entre servidor e cliente, permitindo que eventos disparados no servidor sejam recebidos pelo cliente e vice-versa.

==== dispatch() e listen()

A API do Message Bus segue o padrão publisher-subscriber:

[source,typescript]
----
// Disparar um evento
bus.dispatch("user:login", { userId: "123", name: "João" });

// Escutar eventos
const unsubscribe = bus.listen("user:login", (data) => {
  console.log("Usuário logado:", data.name);
});

// Remover listener
unsubscribe();
----

==== Listeners Wildcard

É possível escutar todos os eventos usando o wildcard `"*"`:

[source,typescript]
----
bus.listen("*", (value, eventName) => {
  console.log(`Evento ${eventName} disparado:`, value);
});
----

Listeners wildcard recebem dois parâmetros:

1. `value` - O valor do evento
2. `eventName` - O nome do evento que foi disparado

==== Último Valor

O Message Bus armazena o último valor de cada evento. Quando um novo listener é registrado, ele recebe imediatamente o último valor (se existir):

[source,typescript]
----
bus.dispatch("counter", 5);

// Este listener recebe o valor 5 imediatamente
bus.listen("counter", (value) => {
  console.log("Counter:", value); // "Counter: 5"
});
----

=== Execução Assíncrona

Todos os callbacks são executados de forma assíncrona usando `queueMicrotask`, garantindo que:

- O método `dispatch()` nunca bloqueia
- Listeners são chamados na ordem de registro
- Não há conflitos de execução síncrona

=== Imutabilidade

O método `state` retorna uma cópia profunda do estado interno, prevenindo mutações acidentais:

[source,typescript]
----
const state = bus.state;
state.foo = "bar"; // Não afeta o estado interno do bus
----

=== Implementações Específicas

O Message Bus possui implementações especializadas para servidor e cliente:

- **ServerMessageBus**: Serialização de estado e integração com HTTP headers
- **ClientMessageBus**: Singleton global e hooks React

Consulte as seções específicas para detalhes de cada implementação.
