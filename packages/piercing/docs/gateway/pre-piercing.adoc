== Pre-Piercing

Pre-piercing é o processo de injetar fragmentos diretamente no HTML inicial da resposta, antes do JavaScript do cliente hidratar a página. Isso melhora o tempo de carregamento percebido e SEO.

=== O Que É Pre-Piercing?

Sem pre-piercing, a página é carregada assim:

[source]
----
1. Servidor envia HTML shell com <fragment-outlet src="...">
2. Cliente baixa JavaScript
3. JavaScript busca fragmentos sob demanda
4. Fragmentos aparecem na tela (FOUC - Flash of Unstyled Content)
----

Com pre-piercing:

[source]
----
1. Servidor detecta <fragment-outlet> e busca fragmentos
2. Servidor injeta <fragment-host> com conteúdo no HTML
3. Cliente vê o conteúdo imediatamente (SSR)
4. JavaScript hidrata os fragmentos (quando carregado)
5. Transição suave, sem FOUC
----

=== Habilitando Pre-Piercing

Pre-piercing é habilitado através do plugin `@buntime/plugin-piercing`. Para usar, adicione o plugin ao arquivo `buntime.jsonc`:

[source,jsonc]
----
{
  "plugins": [
    "@buntime/plugin-piercing"
  ]
}
----

O plugin usa o hook `onResponse` para interceptar respostas HTML e injetar fragmentos automaticamente.

==== Configuração

O plugin pode ser configurado para habilitar/desabilitar o pre-piercing:

[source,jsonc]
----
{
  "plugins": [
    ["@buntime/plugin-piercing", { "enabled": true }]
  ]
}
----

Para desabilitar temporariamente, remova o plugin da lista ou defina `enabled: false`.

=== Como Funciona

==== 1. Detecção de Outlets

Quando uma resposta HTML é processada, o plugin:

1. Verifica se o `Content-Type` é `text/html`
2. Escaneia o HTML buscando `<fragment-outlet src="...">` elements
3. Extrai os atributos `src` de cada outlet encontrado

[source,html]
----
<!-- HTML original -->
<div id="app">
  <fragment-outlet src="/p/metrics" base="/cpanel"></fragment-outlet>
  <fragment-outlet src="/p/health" base="/cpanel"></fragment-outlet>
</div>
----

==== 2. Busca de Fragmentos

Para cada `src` encontrado, o plugin:

1. Resolve a URL relativa usando o contexto da aplicação
2. Faz uma requisição `fetch` para buscar o conteúdo
3. Processa respostas em paralelo para melhor performance

[source,typescript]
----
// URLs encontradas são buscadas em paralelo
const fragments = await Promise.all(
  sources.map(src => fetch(src))
);
----

==== 3. Injeção no HTML

Os fragmentos são envolvidos em `<fragment-host src="...">` e injetados antes de `</body>`:

[source,html]
----
<!DOCTYPE html>
<html>
  <head>...</head>
  <body>
    <div id="app">
      <fragment-outlet src="/p/metrics" base="/cpanel"></fragment-outlet>
      <fragment-outlet src="/p/health" base="/cpanel"></fragment-outlet>
    </div>

    <!-- Fragmentos injetados pelo plugin -->
    <fragment-host src="/p/metrics">
      <div class="metrics-dashboard">...</div>
    </fragment-host>
    <fragment-host src="/p/health">
      <div class="health-status">...</div>
    </fragment-host>
  </body>
</html>
----

==== 4. Hidratação no Cliente

Quando o JavaScript carrega no cliente:

1. O `<fragment-outlet>` detecta que já existe um `<fragment-host>` com o mesmo `src`
2. Em vez de fazer fetch, move o host existente para dentro do outlet
3. Isso resulta em zero requisições adicionais e renderização instantânea

[source,typescript]
----
// No fragment-outlet.ts
const existingHost = document.querySelector(`fragment-host[src="${src}"]`);
if (existingHost) {
  // Pre-pierced! Move host into outlet
  this.shadowRoot.appendChild(existingHost);
  return;
}

// Not pre-pierced, fetch normally
const response = await fetch(src);
// ...
----

=== Comportamento de Streaming

O plugin não processa respostas com `Transfer-Encoding: chunked` para evitar problemas com streaming. Respostas streaming são passadas sem modificação.

Para aproveitar pre-piercing com respostas HTML, certifique-se de que o servidor envia a resposta completa (não chunked).

=== Tratamento de Erros

==== Fragmento Falha ao Carregar

Se um fragmento falha no pre-piercing:

1. Erro é logado no console do servidor
2. Fragmento é ignorado silenciosamente
3. Outros fragmentos são processados normalmente
4. Cliente fará fetch normalmente quando o JavaScript carregar

[source,console]
----
[plugin-piercing] Failed to fetch fragment from /p/metrics: 500
----

==== HTML sem Tag `</body>`

Se o HTML não contém `</body>`, os fragmentos são concatenados ao final do documento.

=== Limitações

1. **Streaming**: Respostas chunked não são processadas
2. **URLs Relativas**: URLs são resolvidas usando o contexto da app
3. **Timeout**: Não há timeout configurável (usa o timeout padrão do fetch)
4. **Autenticação**: Fragmentos são buscados sem headers de autenticação da requisição original

=== Exemplo Completo

==== buntime.jsonc

[source,jsonc]
----
{
  "plugins": [
    ["@buntime/plugin-proxy", {
      "rules": [
        { "path": "/cpanel/*", "target": "cpanel@latest" }
      ]
    }],
    "@buntime/plugin-piercing"
  ]
}
----

==== Shell HTML (cpanel)

[source,html]
----
<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
    <script type="module" src="/p/piercing/client.js"></script>
  </head>
  <body>
    <nav>...</nav>
    <main>
      <fragment-outlet src="/p/metrics" base="/cpanel"></fragment-outlet>
    </main>
  </body>
</html>
----

==== Resultado com Pre-Piercing

[source,html]
----
<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
    <script type="module" src="/p/piercing/client.js"></script>
  </head>
  <body>
    <nav>...</nav>
    <main>
      <fragment-outlet src="/p/metrics" base="/cpanel"></fragment-outlet>
    </main>

    <fragment-host src="/p/metrics">
      <div class="metrics-dashboard">
        <h1>Metrics</h1>
        <!-- Conteúdo completo do fragmento -->
      </div>
    </fragment-host>
  </body>
</html>
----

=== Debugging

Para verificar se pre-piercing está funcionando:

1. **No servidor**: Verifique os logs para mensagens do plugin
2. **No cliente**: Inspecione o HTML fonte (View Source) para ver `<fragment-host>` elements
3. **Network tab**: Com pre-piercing, não deve haver requisições fetch para fragmentos

[source,console]
----
# Logs do servidor com pre-piercing habilitado
[plugin-piercing] Piercing plugin initialized (pre-piercing enabled)
[plugin-piercing] Found 2 fragment outlet(s) to pre-pierce
[plugin-piercing] Pre-pierced 2 fragment(s)
----
