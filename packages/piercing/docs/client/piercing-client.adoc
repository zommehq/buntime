== PiercingClient

API principal para comunicação entre fragmentos e shell, independente da estratégia de sandbox utilizada.

=== Função getPiercingClient()

Retorna a instância singleton do cliente Piercing. Seguro para chamar múltiplas vezes - sempre retorna a mesma instância.

[source,typescript]
----
import { getPiercingClient } from '@buntime/piercing/client';

const piercing = getPiercingClient();

// Lê estado compartilhado
const user = piercing.state.user;

// Escuta mudanças de estado
piercing.onStateChange((state) => {
  console.log('Estado atualizado:', state);
});

// Dispara evento para o shell
piercing.dispatch('cart:updated', { items: 3 });

// Escuta eventos do shell ou outros fragmentos
piercing.on('theme:changed', (theme) => {
  console.log('Tema alterado para:', theme);
});
----

=== Interface PiercingClient

==== Propriedade state

Estado compartilhado atual do shell. Propriedade somente leitura.

[source,typescript]
----
interface PiercingClient {
  readonly state: MessageBusState;
}
----

==== Método onStateChange()

Registra um listener para mudanças no estado do shell.

[source,typescript]
----
onStateChange(callback: (state: MessageBusState) => void): () => void
----

**Parâmetros:**

- `callback` - Função chamada quando o estado muda

**Retorna:** Função de cleanup para parar de escutar

**Exemplo:**

[source,typescript]
----
const cleanup = piercing.onStateChange((state) => {
  console.log('Novo estado:', state);
});

// Parar de escutar
cleanup();
----

==== Método dispatch()

Dispara um evento para o shell e outros fragmentos.

[source,typescript]
----
dispatch(eventName: string, payload: JSONValue): void
----

**Parâmetros:**

- `eventName` - Nome do evento
- `payload` - Dados a enviar com o evento

**Exemplo:**

[source,typescript]
----
piercing.dispatch('user:logged-in', {
  userId: '123',
  name: 'John Doe'
});
----

==== Método on()

Escuta eventos do shell ou outros fragmentos.

[source,typescript]
----
on<T extends JSONValue = JSONValue>(
  eventName: string,
  callback: (payload: T) => void
): () => void
----

**Parâmetros:**

- `eventName` - Nome do evento a escutar
- `callback` - Função chamada quando o evento é recebido

**Retorna:** Função de cleanup para parar de escutar

**Exemplo:**

[source,typescript]
----
const cleanup = piercing.on<{ theme: string }>('theme:changed', (payload) => {
  document.body.className = payload.theme;
});

// Parar de escutar
cleanup();
----

==== Método navigate()

Navega dentro do fragmento, notificando o shell.

[source,typescript]
----
navigate(url: string, options?: {
  replace?: boolean;
  state?: JSONValue
}): void
----

**Parâmetros:**

- `url` - URL para navegar (relativa ao mount path do fragmento)
- `options.replace` - Se `true`, substitui a entrada do histórico ao invés de adicionar
- `options.state` - Estado customizado para associar à navegação

**Exemplo:**

[source,typescript]
----
// Adiciona ao histórico
piercing.navigate('/produto/123');

// Substitui a entrada atual
piercing.navigate('/login', { replace: true });

// Com estado customizado
piercing.navigate('/checkout', {
  state: { from: 'cart' }
});
----

=== Hook usePiercingState()

Hook React para acessar o estado compartilhado do Piercing.

[source,typescript]
----
import { usePiercingState } from '@buntime/piercing/client';

function MyComponent() {
  const state = usePiercingState();
  return <div>Tema: {state.theme}</div>;
}
----

NOTE: Para integração completa com React e re-renderização automática, use `getPiercingClient()` com `useState` e `useEffect`.

=== Uso com React

[source,typescript]
----
import { getPiercingClient } from '@buntime/piercing/client';
import { useEffect, useState } from 'react';

function MyComponent() {
  const piercing = getPiercingClient();
  const [user, setUser] = useState(piercing.state.user);

  useEffect(() => {
    // Escuta mudanças no estado
    return piercing.onStateChange((state) => {
      setUser(state.user);
    });
  }, []);

  return <div>Olá {user?.name}</div>;
}
----

=== SSR (Server-Side Rendering)

Em ambientes SSR (onde `window` não existe), `getPiercingClient()` retorna um cliente no-op que não realiza operações, evitando erros.

[source,typescript]
----
// Seguro em SSR
const piercing = getPiercingClient();
const user = piercing.state.user; // {}
----
