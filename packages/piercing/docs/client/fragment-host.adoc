== FragmentHost

API para acesso ao elemento host do fragmento e registro de handlers de cleanup.

=== Elemento fragment-host

O elemento `<fragment-host>` é usado para pre-piercing e marcação de conteúdo de fragmentos no servidor.

**Atributos:**

- `src` - Caminho do fragmento (ex: `/p/metrics`), deve corresponder ao atributo `src` do `fragment-outlet` correspondente

**Funcionamento:**

1. O servidor injeta `<fragment-host src="/p/metrics">...conteúdo...</fragment-host>` antes de `</body>`
2. O `fragment-outlet` com `src="/p/metrics"` move este conteúdo para seu shadow DOM
3. O elemento host mantém referência ao `src` original para identificação

**Exemplo HTML:**

[source,html]
----
<!-- Servidor injeta antes de </body> -->
<fragment-host src="/p/metrics">
  <div>Conteúdo pré-renderizado do fragmento</div>
</fragment-host>

<!-- Shell define onde o fragmento aparece -->
<fragment-outlet src="/p/metrics"></fragment-outlet>
----

=== Função getFragmentHost()

Retorna o elemento `fragment-host` mais próximo na árvore DOM. Permite que fragmentos acessem metadados e registrem handlers de cleanup.

[source,typescript]
----
import { getFragmentHost, getBus } from '@buntime/piercing/client';

const element = document.getElementById('my-element');
const host = getFragmentHost(element);

console.log('Fragment src:', host?.src);

// Registra cleanup quando o fragmento for removido
host?.onCleanup(() => {
  console.log('Fragmento removido, limpando recursos...');
  getBus(element).dispatch('my-state', null);
});
----

**Parâmetros:**

- `element` - Elemento inicial para buscar (opcional)

**Retorna:** `FragmentHost | null` - O host mais próximo ou `null` se não estiver dentro de um fragmento

=== Interface FragmentHost

Representa o elemento host que contém um fragmento.

[source,typescript]
----
interface FragmentHost extends HTMLElement {
  src: string;
  onCleanup(handler: () => void): void;
}
----

==== Propriedade src

Caminho do fragmento (ex: `/p/metrics`). Corresponde ao atributo `src` do `fragment-outlet`.

[source,typescript]
----
const host = getFragmentHost(element);
console.log('Fragment src:', host?.src);
----

==== Método onCleanup()

Registra um handler para executar quando o fragmento for removido do DOM.

[source,typescript]
----
onCleanup(handler: () => void): void
----

**Parâmetros:**

- `handler` - Função a chamar na limpeza

**Casos de uso:**

- Cancelar subscriptions
- Limpar estado compartilhado
- Liberar recursos
- Notificar outros fragmentos da remoção

**Exemplo:**

[source,typescript]
----
const host = getFragmentHost(myElement);

host?.onCleanup(() => {
  // Limpa estado compartilhado
  getBus(myElement).dispatch('my-event', null);

  // Cancela timers
  clearInterval(intervalId);

  // Notifica outros fragmentos
  getPiercingClient().dispatch('fragment:removed', {
    src: host.src
  });
});
----

=== Uso com React

[source,typescript]
----
import { getFragmentHost, getBus } from '@buntime/piercing/client';
import { useEffect, useRef } from 'react';

function MyComponent() {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const host = getFragmentHost(ref.current);

    // Registra cleanup quando o fragmento é removido
    host?.onCleanup(() => {
      // Limpa estado
      getBus(ref.current).dispatch('my-state', null);

      // Outras operações de cleanup
      console.log('Fragmento desmontado');
    });
  }, []);

  return <div ref={ref}>Conteúdo do fragmento</div>;
}
----

=== Uso com Vanilla JS

[source,typescript]
----
// Em qualquer lugar dentro de um fragmento
const myElement = document.getElementById('my-element');
const host = getFragmentHost(myElement);

if (host) {
  console.log('Dentro do fragmento:', host.src);

  // Registra cleanup
  host.onCleanup(() => {
    // Cleanup quando o fragmento for removido
    sessionStorage.removeItem(`fragment-${host.src}`);
  });
} else {
  console.log('Não está dentro de um fragmento');
}
----

=== Diferença entre Cleanup e useEffect

**onCleanup()** é chamado quando o fragmento é removido do DOM pelo shell.

**useEffect cleanup** é chamado quando o componente React desmonta.

[source,typescript]
----
function MyComponent() {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const host = getFragmentHost(ref.current);

    // Cleanup quando o FRAGMENTO é removido (pelo shell)
    host?.onCleanup(() => {
      console.log('Shell removeu o fragmento');
    });

    // Cleanup quando o COMPONENTE desmonta
    return () => {
      console.log('Componente React desmontou');
    };
  }, []);

  return <div ref={ref}>...</div>;
}
----

NOTE: Se o fragmento inteiro for removido, ambos os cleanups serão executados. `onCleanup()` é útil para notificar outros fragmentos ou o shell.

=== SSR (Server-Side Rendering)

Em ambientes SSR, `getFragmentHost()` retorna `null`.

[source,typescript]
----
// Seguro em SSR
const host = getFragmentHost(element); // null
----
