= KeyVal
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

ifdef::env-github[]
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: âš ï¸
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
endif::[]

image:https://img.shields.io/badge/Bun-1.x-blue[Bun]
image:https://img.shields.io/badge/libSQL-latest-green[libSQL]
image:https://img.shields.io/badge/TypeScript-5.0+-blue[TypeScript]
image:https://img.shields.io/badge/API-Deno_KV-purple[Deno KV Compatible]

toc::[]

== VisÃ£o Geral

**KeyVal** Ã© um cliente de key-value store com API idÃªntica ao https://deno.land/kv[Deno KV], porÃ©m utilizando https://turso.tech/libsql[libSQL] como backend de armazenamento.

O objetivo Ã© fornecer uma experiÃªncia familiar para desenvolvedores que conhecem Deno KV, permitindo migraÃ§Ã£o fÃ¡cil e uso em ambientes Bun/Node.js.

=== CaracterÃ­sticas

* **API compatÃ­vel com Deno KV** - Mesma interface de programaÃ§Ã£o
* **Backend libSQL** - Armazenamento SQLite distribuÃ­do via Turso
* **Chaves compostas** - Arrays de strings, nÃºmeros, booleans e Uint8Array
* **TTL nativo** - ExpiraÃ§Ã£o automÃ¡tica de entradas
* **TransaÃ§Ãµes atÃ´micas** - OperaÃ§Ãµes com controle de concorrÃªncia otimista
* **OperaÃ§Ãµes atÃ´micas** - sum, max, min, append, prepend (sem read-modify-write)
* **Listagem por prefixo** - IteraÃ§Ã£o eficiente sobre grupos de chaves
* **getMany otimizado** - Busca mÃºltiplas chaves em uma Ãºnica requisiÃ§Ã£o
* **Filas de mensagens** - enqueue/listenQueue com retry e backoff
* **Watch** - Monitoramento de mudanÃ§as em tempo real (SSE/polling) com backpressure
* **Consistency modes** - Strong (primary) e Eventual (replica)

== Quick Start

=== InstalaÃ§Ã£o

[source,bash]
----
bun add @buntime/keyval
----

=== ConfiguraÃ§Ã£o do libSQL

O KeyVal requer uma instÃ¢ncia libSQL rodando. Para desenvolvimento local:

[source,bash]
----
# Via Docker
docker run -d \
  -p 8880:8080 \
  -p 8881:5000 \
  ghcr.io/tursodatabase/libsql-server:latest

# Ou via docker-compose (veja docker-compose.yml na raiz do projeto)
docker compose up -d libsql
----

=== Uso BÃ¡sico

[source,typescript]
----
import { Kv } from "@buntime/keyval";

// Conectar ao KeyVal (via plugin buntime)
const kv = new Kv("http://localhost:8000/_/plugin-keyval");

// Armazenar um valor
await kv.set(["users", 123], { name: "Alice", email: "alice@example.com" });

// Recuperar um valor
const entry = await kv.get(["users", 123]);
console.log(entry.value); // { name: "Alice", email: "alice@example.com" }

// Listar por prefixo
for await (const entry of kv.list({ prefix: ["users"] })) {
  console.log(entry.key, entry.value);
}

// Deletar
await kv.delete(["users", 123]);
----

== Arquitetura

=== Componentes

[source]
----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AplicaÃ§Ã£o                            â”‚
â”‚                    (Worker/App Buntime)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   @buntime/keyval                           â”‚
â”‚                   (Cliente HTTP)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                @buntime/plugin-keyval                       â”‚
â”‚                   (Plugin Server)                           â”‚
â”‚   Rotas: /_/plugin-keyval/keys/*                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ libSQL Protocol
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      libSQL Server                          â”‚
â”‚              (SQLite distribuÃ­do/Turso)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

=== Schema do Banco

[source,sql]
----
-- Tabela de entradas KV
CREATE TABLE kv_entries (
  key BLOB PRIMARY KEY,        -- Chave codificada em bytes
  value BLOB NOT NULL,         -- Valor serializado em JSON
  versionstamp TEXT NOT NULL,  -- VersÃ£o para controle de concorrÃªncia
  expires_at INTEGER           -- Unix timestamp de expiraÃ§Ã£o (opcional)
);

CREATE INDEX idx_kv_expires ON kv_entries(expires_at)
  WHERE expires_at IS NOT NULL;

-- Tabela de fila de mensagens
CREATE TABLE kv_queue (
  id TEXT PRIMARY KEY,              -- UUID da mensagem
  value BLOB NOT NULL,              -- Payload serializado
  ready_at INTEGER NOT NULL,        -- Quando ficarÃ¡ disponÃ­vel
  attempts INTEGER DEFAULT 0,       -- Tentativas de entrega
  max_attempts INTEGER DEFAULT 5,   -- MÃ¡ximo de tentativas
  backoff_schedule TEXT,            -- JSON array de delays
  keys_if_undelivered TEXT,         -- Fallback keys
  status TEXT DEFAULT 'pending',    -- pending | processing | failed
  locked_until INTEGER,             -- Lock timestamp
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
----

== ConfiguraÃ§Ã£o no Buntime

Para usar o KeyVal em um projeto Buntime, configure o plugin no `buntime.jsonc`:

[source,jsonc]
----
{
  "plugins": [
    ["@buntime/plugin-keyval", {
      "libsqlUrl": "${LIBSQL_URL}",      // URL do servidor libSQL
      "libsqlToken": "${LIBSQL_TOKEN}"   // Token de autenticaÃ§Ã£o (opcional)
    }]
  ]
}
----

=== VariÃ¡veis de Ambiente

[source,bash]
----
# Desenvolvimento local
LIBSQL_URL=http://localhost:8880

# ProduÃ§Ã£o (Turso)
LIBSQL_URL=libsql://your-database.turso.io
LIBSQL_TOKEN=your-auth-token
----

== ComparaÃ§Ã£o com Deno KV

[cols="1,1,1"]
|===
| Feature | Deno KV | KeyVal

| Backend
| FoundationDB (Deno Deploy) / SQLite (local)
| libSQL (Turso/SQLite)

| Ambiente
| Deno
| Bun/Node.js

| DistribuÃ­do
| Sim (Deno Deploy)
| Sim (Turso)

| Chaves Compostas
| Sim
| Sim

| TTL
| Sim
| Sim

| TransaÃ§Ãµes AtÃ´micas
| Sim
| Sim

| sum/max/min
| Sim (via mutate)
| Sim (mÃ©todos dedicados)

| append/prepend
| NÃ£o
| Sim

| getMany otimizado
| Sim
| Sim (batch endpoint)

| Watch (Streaming)
| Sim
| Sim (SSE/polling)

| Watch Backpressure
| NÃ£o
| Sim (bufferSize, overflowStrategy)

| Enqueue/ListenQueue
| Sim
| Sim

| commitVersionstamp()
| Sim
| Sim

| Consistency Modes
| Sim
| Sim (strong/eventual)
|===

include::docs/operations.adoc[leveloffset=+1]

include::docs/keys.adoc[leveloffset=+1]

include::docs/expiration.adoc[leveloffset=+1]

include::docs/transactions.adoc[leveloffset=+1]

include::docs/secondary-indexes.adoc[leveloffset=+1]

include::docs/queues.adoc[leveloffset=+1]

include::docs/watch.adoc[leveloffset=+1]

include::docs/consistency.adoc[leveloffset=+1]
