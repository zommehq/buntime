services:
  # =============================================================================
  # Production: Compiled binary with minimal image
  # Usage: docker-compose --profile prod up
  # =============================================================================
  buntime-prod:
    container_name: buntime
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ${RUNTIME_WORKER_DIRS:-./tmp/apps}:/data/apps
      - ${RUNTIME_PLUGIN_DIRS:-./tmp/plugins}:/data/plugins
      # App shell (front-manager)
      - ${GATEWAY_SHELL_DIR:-/tmp/apps/front-manager}:/data/apps/front-manager
    environment:
      RUNTIME_LOG_LEVEL: ${RUNTIME_LOG_LEVEL:-info}
      RUNTIME_PLUGIN_DIRS: /data/.plugins:/data/plugins
      RUNTIME_WORKER_DIRS: /data/.apps:/data/apps
      # Plugin: Database
      DATABASE_LIBSQL_URL: http://libsql:8080
      # Plugin: Gateway
      GATEWAY_SHELL_DIR: /data/apps/front-manager
      GATEWAY_SHELL_EXCLUDES: ${GATEWAY_SHELL_EXCLUDES:-}
    depends_on:
      - libsql
    restart: unless-stopped
    profiles:
      - prod
  # =============================================================================
  # Development: Hot reload with source mounted as volumes
  # Usage: docker-compose --profile dev up
  # =============================================================================
  buntime-dev:
    container_name: buntime
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "8000:8000"
    volumes:
      # Source code (for hot reload) - mounted in /build for bun workspaces
      - ./packages:/build/packages
      - ./apps:/build/apps
      - ./plugins:/build/plugins
      # Internal apps and plugins symlinked to /data for runtime
      - ./apps:/data/.apps
      - ./plugins:/data/.plugins
      # External apps and plugins (from env)
      - ${RUNTIME_WORKER_DIRS:-./tmp/apps}:/data/apps
      - ${RUNTIME_PLUGIN_DIRS:-./tmp/plugins}:/data/plugins
      # App shell (front-manager)
      - ${GATEWAY_SHELL_DIR:-/tmp/apps/front-manager}:/data/apps/front-manager
    environment:
      # Runtime
      NODE_ENV: development
      PORT: 8000
      RUNTIME_API_PREFIX: /_
      RUNTIME_LOG_LEVEL: debug
      RUNTIME_PLUGIN_DIRS: /data/.plugins:/data/plugins
      RUNTIME_POOL_SIZE: 10
      RUNTIME_WORKER_DIRS: /data/.apps:/data/apps
      # Plugin: Database
      DATABASE_LIBSQL_URL: http://libsql:8080
      # Plugin: Gateway
      GATEWAY_SHELL_DIR: /data/apps/front-manager
      GATEWAY_SHELL_EXCLUDES: ${GATEWAY_SHELL_EXCLUDES:-}
    depends_on:
      - libsql
    profiles:
      - dev
  # =============================================================================
  # LibSQL
  # =============================================================================
  libsql:
    image: ghcr.io/tursodatabase/libsql-server:latest
    ports:
      - "8880:8080" # HTTP API
      - "8881:5001" # gRPC API (for replication)
    volumes:
      - libsql-data:/var/lib/sqld
    environment:
      SQLD_NODE: primary
      SQLD_HTTP_LISTEN_ADDR: 0.0.0.0:8080
      SQLD_GRPC_LISTEN_ADDR: 0.0.0.0:5001
      # Development mode - no auth required
      SQLD_DISABLE_AUTH: "true"
    restart: unless-stopped
  # libsql-replica:
  #   image: ghcr.io/tursodatabase/libsql-server:latest
  #   ports:
  #     - "8882:8080" # HTTP API (replica)
  #   volumes:
  #     - libsql-replica-data:/var/lib/sqld
  #   environment:
  #     SQLD_NODE: replica
  #     SQLD_PRIMARY_URL: http://libsql:5001
  #     SQLD_HTTP_LISTEN_ADDR: 0.0.0.0:8080
  #     SQLD_DISABLE_AUTH: "true"
  #   depends_on:
  #     libsql:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #   restart: unless-stopped
volumes:
  libsql-data:
  # libsql-replica-data:
