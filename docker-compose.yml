services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    command: start-dev
    ports:
      - "8180:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_RELATIVE_PATH: /auth
    volumes:
      - keycloak-data:/opt/keycloak/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /auth/health/ready HTTP/1.1\\r\\nhost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  libsql:
    image: ghcr.io/tursodatabase/libsql-server:latest
    ports:
      - "8880:8080" # HTTP API
      - "8881:5001" # gRPC API (for replication)
    volumes:
      - libsql-data:/var/lib/sqld
    environment:
      SQLD_NODE: primary
      SQLD_HTTP_LISTEN_ADDR: 0.0.0.0:8080
      SQLD_GRPC_LISTEN_ADDR: 0.0.0.0:5001
      # Development mode - no auth required
      SQLD_DISABLE_AUTH: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # libsql-replica:
  #   image: ghcr.io/tursodatabase/libsql-server:latest
  #   ports:
  #     - "8882:8080" # HTTP API (replica)
  #   volumes:
  #     - libsql-replica-data:/var/lib/sqld
  #   environment:
  #     SQLD_NODE: replica
  #     SQLD_PRIMARY_URL: http://libsql:5001
  #     SQLD_HTTP_LISTEN_ADDR: 0.0.0.0:8080
  #     SQLD_DISABLE_AUTH: "true"
  #   depends_on:
  #     libsql:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #   restart: unless-stopped

  buntime:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8001:8000"
    volumes:
      - ./tmp:/app/apps
    environment:
      PORT: 8000
      LIBSQL_URL: http://libsql:8080
      WORKSPACES_DIR: /app/apps
    # depends_on:
    #   libsql:
    #     condition: service_healthy
    restart: unless-stopped

  # Rancher for Kubernetes cluster management and Helm chart testing
  # Access at https://localhost:8443 (self-signed cert warning expected)
  # First login: get bootstrap password with:
  #   docker logs buntime-rancher-1 2>&1 | grep "Bootstrap Password:"
  rancher:
    image: rancher/rancher:latest # pass: f3t2KuFbiIFnj0Rr
    privileged: true
    ports:
      - "8443:443"
      - "8080:80"
    volumes:
      - rancher-data:/var/lib/rancher
    environment:
      CATTLE_BOOTSTRAP_PASSWORD: admin
    restart: unless-stopped

volumes:
  keycloak-data:
  libsql-data:
  libsql-replica-data:
  rancher-data:
