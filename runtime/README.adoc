= Buntime Runtime
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

ifdef::env-github[]
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: âš ï¸
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
endif::[]

toc::[]

== VisÃ£o Geral

Worker pool runner para aplicaÃ§Ãµes Bun, projetado como engine para uma plataforma serverless.

=== Features

* **Worker Pool Management** - Spawning dinÃ¢mico, pool size configurÃ¡vel, lifecycle automÃ¡tico
* **Semantic Versioning** - Suporte a `app@1.0.0`, `app@1`, `app@latest`
* **Plugin System** - Config JSONC, lifecycle hooks, ordenaÃ§Ã£o topolÃ³gica por dependÃªncias
* **Base Path Injection** - Suporte a SPAs sob subpaths via `<base href>`

=== Plugins DisponÃ­veis

O runtime carrega plugins conforme configurado em `buntime.jsonc`. Plugins disponÃ­veis:

[cols="1,2"]
|===
| Plugin | DescriÃ§Ã£o

| `@buntime/plugin-authn`
| AutenticaÃ§Ã£o (Keycloak/OIDC/JWT, email-password)

| `@buntime/plugin-authz`
| AutorizaÃ§Ã£o com polÃ­ticas XACML

| `@buntime/plugin-database`
| Adaptadores de banco (libsql, sqlite)

| `@buntime/plugin-deployments`
| Gerenciamento de apps (upload, download, exclusÃ£o)

| `@buntime/plugin-durable`
| Durable Objects (Cloudflare-like)

| `@buntime/plugin-gateway`
| Cache e rate limiting

| `@buntime/plugin-health`
| Health checks e probes Kubernetes

| `@buntime/plugin-keyval`
| Key-value store (Deno KV-like)

| `@buntime/plugin-logs`
| Logs em memÃ³ria com SSE streaming

| `@buntime/plugin-metrics`
| MÃ©tricas Prometheus e SSE

| `@buntime/plugin-piercing`
| Fragment piercing (micro-frontends)

| `@buntime/plugin-proxy`
| Proxy reverso com regras dinÃ¢micas
|===

NOTE: Plugins devem ser habilitados em `buntime.jsonc` para estarem disponÃ­veis.

=== Tech Stack

Bun, Hono, Zod, quick-lru, semver

== Estrutura do Projeto

[source]
----
runtime/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # Entry point (Bun.serve)
â”‚   â”œâ”€â”€ api.ts            # Hono app (agregador de rotas)
â”‚   â”œâ”€â”€ app.ts            # LÃ³gica de resoluÃ§Ã£o de requests
â”‚   â”œâ”€â”€ config.ts         # ConfiguraÃ§Ã£o do runtime
â”‚   â”œâ”€â”€ constants.ts      # Constantes e variÃ¡veis de ambiente
â”‚   â”œâ”€â”€ libs/
â”‚   â”‚   â””â”€â”€ pool/         # Gerenciamento do worker pool
â”‚   â”‚       â”œâ”€â”€ pool.ts       # Classe WorkerPool, LRU cache
â”‚   â”‚       â”œâ”€â”€ instance.ts   # Lifecycle do WorkerInstance
â”‚   â”‚       â”œâ”€â”€ wrapper.ts    # CÃ³digo executado no worker thread
â”‚   â”‚       â”œâ”€â”€ config.ts     # ConfiguraÃ§Ã£o de workers
â”‚   â”‚       â”œâ”€â”€ metrics.ts    # MÃ©tricas do pool
â”‚   â”‚       â”œâ”€â”€ stats.ts      # UtilitÃ¡rios estatÃ­sticos
â”‚   â”‚       â””â”€â”€ types.ts      # Tipos de mensagens
â”‚   â”œâ”€â”€ plugins/
â”‚   â”‚   â”œâ”€â”€ builtin.ts    # Resolvers de plugins builtin
â”‚   â”‚   â”œâ”€â”€ loader.ts     # Carregamento de plugins
â”‚   â”‚   â””â”€â”€ registry.ts   # Registry e lifecycle de plugins
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ plugins-info.ts   # GET /api/plugins
â”‚   â”‚   â””â”€â”€ worker.ts         # Rotas de apps
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ get-app-dir.ts     # ResoluÃ§Ã£o de versÃ£o de apps
â”‚       â”œâ”€â”€ get-entrypoint.ts  # DetecÃ§Ã£o de entrypoint
â”‚       â”œâ”€â”€ plugins.ts         # UtilitÃ¡rios de plugins
â”‚       â”œâ”€â”€ request.ts         # Clonagem de body, rewrite de URL
â”‚       â””â”€â”€ serve-static.ts    # Serving de arquivos estÃ¡ticos
â”œâ”€â”€ buntime.jsonc         # ConfiguraÃ§Ã£o do runtime
â”œâ”€â”€ buntime.example.jsonc # Exemplo de configuraÃ§Ã£o
â””â”€â”€ package.json
----

== ConfiguraÃ§Ã£o

=== buntime.jsonc (Runtime)

[source,jsonc]
----
{
  "workspaces": ["./apps"],      // DiretÃ³rios das aplicaÃ§Ãµes
  "poolSize": 100,               // Tamanho do pool
  "homepage": "my-app",          // App padrÃ£o para raiz (opcional)
  "bodySize": {                  // Limites de body (opcional)
    "default": "10mb",
    "max": "100mb"
  },
  "plugins": [
    "@buntime/plugin-metrics",
    ["@buntime/plugin-deployments", {
      "excludes": [".cache"]
    }]
  ]
}
----

[cols="1,1,1,2"]
|===
| OpÃ§Ã£o | Tipo | Default | DescriÃ§Ã£o

| `workspaces`
| string[]
| (obrigatÃ³rio)
| DiretÃ³rios de apps (suporta `${ENV_VAR}`)

| `poolSize`
| number
| 500 (prod), 10 (dev)
| Tamanho mÃ¡ximo do pool

| `homepage`
| string \| object
| -
| App para servir na raiz

| `bodySize.default`
| string \| number
| 10mb
| Limite padrÃ£o de body

| `bodySize.max`
| string \| number
| 100mb
| Limite mÃ¡ximo de body

| `plugins`
| array
| []
| Plugins a carregar
|===

=== buntime.jsonc (Por App)

Cada app pode ter seu prÃ³prio `buntime.jsonc` na raiz:

[source,jsonc]
----
{
  "entrypoint": "server.ts",
  "timeout": 30,
  "ttl": 60,
  "maxRequests": 1000,
  "idleTimeout": 60,
  "autoInstall": false,
  "lowMemory": false
}
----

[cols="1,1,1,2"]
|===
| OpÃ§Ã£o | Tipo | Default | DescriÃ§Ã£o

| `autoInstall`
| boolean
| false
| Executa `bun install` antes de iniciar worker

| `entrypoint`
| string
| auto
| Entrypoint da aplicaÃ§Ã£o

| `idleTimeout`
| number \| string
| 60
| Tempo de idle antes de terminar (segundos ou "1m")

| `lowMemory`
| boolean
| false
| Ativa modo low-memory

| `maxBodySize`
| number \| string
| (do runtime)
| Limite de body por app ("10mb", 1048576)

| `maxRequests`
| number
| 1000
| MÃ¡ximo de requests antes de reciclar

| `publicRoutes`
| string[] \| object
| -
| Rotas pÃºblicas (sem autenticaÃ§Ã£o)

| `timeout`
| number \| string
| 30
| Timeout de request (segundos ou "30s")

| `ttl`
| number \| string
| 0
| TTL do worker (0 = sem limite)
|===

=== Base Path para SPAs

Quando uma SPA precisa rodar sob um subpath (ex: `/cpanel`), o runtime injeta automaticamente a tag `<base href>` em respostas HTML.

==== Como Funciona

O header `x-base` Ã© adicionado Ã s requests para workers. O worker wrapper (`wrapper.ts`) injeta a tag base no HTML:

[source,typescript]
----
// wrapper.ts - injeta base em respostas HTML
const base = req.headers.get("x-base");
const isHtml = contentType?.includes("text/html");

if (isHtml && base) {
  const html = text.replace("<head>", `<head><base href="${base}/" />`);
  // ...
}
----

==== ConfiguraÃ§Ã£o no Proxy

[source,jsonc]
----
// buntime.jsonc com plugin-proxy
{
  "plugins": [
    ["@buntime/plugin-proxy", {
      "rules": [
        {
          "name": "CPanel App",
          "pattern": "^/cpanel(/.*)?$",
          "target": "http://localhost:4000",
          "rewrite": "$1",
          "base": "/cpanel"
        }
      ]
    }]
  ]
}
----

== Rotas

=== API Routes (Runtime)

* `GET /api/plugins` - Lista plugins carregados com menus e configuraÃ§Ãµes

=== Plugin Routes

Plugins registram suas rotas sob `/{base}/*`:

* `/authn/*` - AutenticaÃ§Ã£o (plugin-authn)
* `/authz/*` - AutorizaÃ§Ã£o (plugin-authz)
* `/deployments/*` - Gerenciamento de apps (plugin-deployments)
* `/durable/*` - Durable Objects (plugin-durable)
* `/gateway/*` - Cache e rate limiting (plugin-gateway)
* `/health/*` - Health checks (plugin-health)
* `/keyval/*` - KeyVal API (plugin-keyval)
* `/logs/*` - Logs (plugin-logs)
* `/metrics/*` - MÃ©tricas (plugin-metrics)
* `/piercing/*` - Fragment piercing (plugin-piercing)
* `/proxy/*` - Proxy reverso (plugin-proxy)

=== Worker Routes

* `ALL /:app` - Roteia para worker da app
* `ALL /:app/*` - Roteia paths aninhados

**ResoluÃ§Ã£o de VersÃ£o:**

[cols="1,2"]
|===
| Request | Resolve para

| `/hello-api`
| VersÃ£o mais alta (ou `latest` se existir)

| `/hello-api@latest`
| DiretÃ³rio `hello-api@latest`

| `/hello-api@1.0.0`
| VersÃ£o exata

| `/hello-api@1`
| Maior versÃ£o 1.x.x

| `/hello-api@^1.0.0`
| Range semver
|===

== Scripts

[source,bash]
----
bun dev              # Watch mode com hot reload
bun lint             # Format + type check
bun test             # Run tests
bun build            # Build runtime
bun build:bin        # Compile to binary
bun build:types      # Build TypeScript types
----

== Arquitetura

=== Request Flow

[source]
----
Request -> Hono Router -> Resolve?
  |-- CSRF Protection
  |-- App-Shell Mode (se configurado)
  |-- Plugin onRequest Hooks
  |-- /api/plugins -> Plugin Info API
  |-- Plugin server.fetch handlers
  |-- Plugin Routes (Hono)
  |-- Plugin Apps (fragments)
  +-- /:app/* -> Worker Pool -> Worker Thread
  +-- 404 com Shell (se configurado)
----

=== PrincÃ­pios de Design

. Main thread orquestra, nunca executa lÃ³gica de app
. Workers proveem isolamento (crash nÃ£o afeta main)
. Pipeline de plugins intercepta requests/responses
. Base path injection permite SPAs sob subpaths
. OrdenaÃ§Ã£o topolÃ³gica garante dependÃªncias entre plugins

=== Worker Lifecycle

[source]
----
Creating -> Ready -> Active <-> Idle -> Terminated
----

== Componentes Principais

[cols="1,2"]
|===
| Componente | Responsabilidade

| `src/index.ts`
| Entry point, Bun.serve, graceful shutdown

| `src/api.ts`
| Hono app, agregador de rotas

| `src/app.ts`
| ResoluÃ§Ã£o de requests, plugin apps

| `src/config.ts`
| ConfiguraÃ§Ã£o do runtime (env + buntime.jsonc)

| `src/libs/pool/pool.ts`
| Classe WorkerPool, LRU cache

| `src/libs/pool/instance.ts`
| Lifecycle do WorkerInstance

| `src/libs/pool/wrapper.ts`
| Request handling no worker, base injection

| `src/plugins/loader.ts`
| Carrega plugins do config

| `src/plugins/registry.ts`
| Lifecycle e hooks dos plugins
|===

== Fundamentals

include::docs/fundamentals/worker-pool.adoc[leveloffset=+1]

include::docs/fundamentals/plugin-system.adoc[leveloffset=+1]

include::docs/fundamentals/server-core.adoc[leveloffset=+1]

include::docs/fundamentals/request-handling.adoc[leveloffset=+1]

== API Reference

include::docs/api/routes.adoc[leveloffset=+1]

== Deployment

include::docs/deployment/local.adoc[leveloffset=+1]

include::docs/deployment/kubernetes.adoc[leveloffset=+1]

include::docs/deployment/configuration.adoc[leveloffset=+1]

== Operations

include::docs/logging.adoc[leveloffset=+1]

== Architecture

include::docs/micro-frontend-architecture.adoc[leveloffset=+1]

== Extras

Conceitos avanÃ§ados usados internamente pelo runtime:

include::docs/extras/topological-sort.adoc[leveloffset=+1]
