= k3s + Rancher
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

Deploy do Buntime em cluster k3s com Rancher, usando Traefik como ingress controller e cert-manager para TLS.

== Pré-requisitos

* k3s instalado com Traefik
* cert-manager configurado com ClusterIssuer
* Helm 3.x
* kubectl configurado para o cluster

=== Verificar Cluster

[source,bash]
----
# Verificar nodes
kubectl get nodes

# Verificar Traefik
kubectl get pods -n traefik

# Verificar cert-manager
kubectl get pods -n cert-manager

# Verificar ClusterIssuer
kubectl get clusterissuer
----

== Deploy via Helm CLI

=== Build da Imagem

Existem duas opções para disponibilizar a imagem no cluster:

==== Opção A: Importar Direto no k3s (Desenvolvimento)

[source,bash]
----
# Build local
docker build -t buntime:latest .

# Salvar imagem
docker save buntime:latest -o /tmp/buntime.tar

# Copiar para o servidor k3s
scp /tmp/buntime.tar user@k3s-server:/tmp/

# No servidor, importar no containerd do k3s
ssh user@k3s-server 'sudo k3s ctr images import /tmp/buntime.tar'

# Verificar
ssh user@k3s-server 'sudo k3s ctr images ls | grep buntime'
----

==== Opção B: Registry Privado (Produção)

[source,bash]
----
# Login no registry (GitLab, Harbor, etc)
docker login registry.example.com

# Build e tag
docker build -t registry.example.com/buntime:latest .

# Push
docker push registry.example.com/buntime:latest
----

=== Criar Namespace

[source,bash]
----
kubectl create namespace buntime
----

=== Criar Arquivo de Values

Criar arquivo `values-k3s.yaml` com configurações para Traefik:

[source,yaml]
----
replicaCount: 1

image:
  repository: buntime  # ou registry.example.com/buntime
  tag: latest
  pullPolicy: IfNotPresent  # Always se usar registry

ingress:
  enabled: true
  className: traefik
  host: buntime.home
  path: "/"
  annotations:
    cert-manager.io/cluster-issuer: home-ca-issuer
  tls:
    enabled: true
    secretName: buntime-tls

buntime:
  port: 8000
  poolSize: 100
  workerDirs: "/data/apps"
  pluginDirs: "/data/plugins"
  logLevel: "info"

persistence:
  plugins:
    enabled: true
    size: 5Gi
  apps:
    enabled: true
    size: 10Gi
----

NOTE: Cada plugin tem seu próprio `manifest.jsonc` no PVC de plugins. Plugins como metrics, deployments, database são configurados individualmente em seus respectivos diretórios.

=== Instalar com Helm

[source,bash]
----
helm install buntime ./charts/buntime \
  --namespace buntime \
  -f values-k3s.yaml
----

=== Verificar Deploy

[source,bash]
----
# Ver pods
kubectl get pods -n buntime

# Ver PVCs
kubectl get pvc -n buntime

# Ver ingress
kubectl get ingress -n buntime

# Ver certificado TLS
kubectl get certificate -n buntime

# Ver logs
kubectl logs -n buntime -l app.kubernetes.io/name=buntime -f
----

=== Acessar

Após o deploy, acesse:

* **Dashboard**: https://buntime.home
* **cpanel**: https://buntime.home/cpanel
* **API de Plugins**: https://buntime.home/api/plugins

== Deploy via Rancher UI

=== Adicionar Repositório Helm

. Acesse https://rancher.home
. No menu lateral, vá em **Apps** > **Repositories**
. Clique em **Create**
. Preencha:
** Name: `buntime-local`
** Index URL: URL do chart ou use Git URL
** Para Git: `https://github.com/djalmajr/buntime.git` com Path `/charts`
. Clique em **Create**

TIP: Para desenvolvimento local, você pode usar o Rancher para adicionar um repositório Git local ou hospedar o chart em um servidor HTTP.

=== Criar Namespace

. No menu lateral, vá em **Cluster** > **Projects/Namespaces**
. Clique em **Create Namespace**
. Preencha:
** Name: `buntime`
** Description: Buntime Runtime
. Clique em **Create**

=== Instalar App

. No menu lateral, vá em **Apps** > **Charts**
. Encontre o chart **buntime**
. Clique em **Install**
. Configure:

==== Metadata

[cols="1,2"]
|===
| Campo | Valor

| Namespace
| `buntime`

| Name
| `buntime`
|===

==== Values YAML

Cole o conteúdo do `values-k3s.yaml` ou edite os campos individuais na UI.

==== Importantes para k3s

[cols="1,2,2"]
|===
| Campo | Valor | Descrição

| `ingress.enabled`
| `true`
| Habilitar ingress

| `ingress.className`
| `traefik`
| Usar Traefik (padrão do k3s)

| `ingress.host`
| `buntime.home`
| Hostname do serviço

| `ingress.tls.enabled`
| `true`
| Habilitar HTTPS

| `ingress.annotations`
| `cert-manager.io/cluster-issuer: home-ca-issuer`
| Usar cert-manager para TLS
|===

. Clique em **Install**

=== Monitorar Deploy

. No menu lateral, vá em **Workloads** > **Deployments**
. Selecione namespace `buntime`
. Clique no deployment `buntime`
. Verifique:
** Status dos pods
** Logs
** Events

=== Verificar Recursos Criados

. **Deployments**: Workloads > Deployments
. **Services**: Service Discovery > Services
. **Ingresses**: Service Discovery > Ingresses
. **PVCs**: Storage > PersistentVolumeClaims
. **ConfigMaps**: Storage > ConfigMaps
. **Certificates**: (via kubectl) `kubectl get certificates -n buntime`

== Troubleshooting

=== Pod não Inicia

[source,bash]
----
# Ver eventos do pod
kubectl describe pod -n buntime -l app.kubernetes.io/name=buntime

# Causas comuns:
# - Imagem não encontrada: verificar repository e tag
# - PVC pending: verificar storage class disponível
# - Falha no probe: verificar logs do container
----

=== Ingress não Funciona

[source,bash]
----
# Verificar ingress
kubectl describe ingress -n buntime buntime

# Verificar certificado
kubectl describe certificate -n buntime buntime-tls

# Verificar Traefik logs
kubectl logs -n traefik -l app.kubernetes.io/name=traefik
----

=== Certificado não Gerado

[source,bash]
----
# Verificar CertificateRequest
kubectl get certificaterequest -n buntime

# Verificar ClusterIssuer
kubectl describe clusterissuer home-ca-issuer

# Verificar cert-manager logs
kubectl logs -n cert-manager -l app=cert-manager
----

=== Conexão com libSQL Falha

[source,bash]
----
# Verificar se libSQL está rodando
kubectl get pods -n libsql

# Testar conectividade do pod buntime
kubectl exec -n buntime -it deployment/buntime -- \
  wget -qO- http://libsql-primary.libsql.svc.cluster.local:8080/health
----

== Atualização

=== Via Helm CLI

[source,bash]
----
# Rebuild imagem (se necessário)
docker build -t buntime:latest .
# Re-importar no k3s ou push para registry

# Upgrade
helm upgrade buntime ./charts/buntime \
  --namespace buntime \
  -f values-k3s.yaml

# Forçar restart dos pods (pull nova imagem)
kubectl rollout restart deployment -n buntime buntime
----

=== Via Rancher UI

. Vá em **Apps** > **Installed Apps**
. Encontre `buntime`
. Clique em **Upgrade**
. Modifique values se necessário
. Clique em **Upgrade**

== Desinstalação

=== Via Helm CLI

[source,bash]
----
helm uninstall buntime --namespace buntime

# Opcional: remover PVCs (dados persistentes)
kubectl delete pvc -n buntime --all

# Opcional: remover namespace
kubectl delete namespace buntime
----

=== Via Rancher UI

. Vá em **Apps** > **Installed Apps**
. Encontre `buntime`
. Clique em **Delete**
. Confirme a remoção

WARNING: A desinstalação via Rancher não remove PVCs automaticamente. Remova manualmente se necessário.

== Configurações Avançadas

=== Múltiplas Réplicas

[source,yaml]
----
replicaCount: 3

# PVC deve ser ReadWriteMany para múltiplas réplicas
persistence:
  plugins:
    enabled: true
    size: 5Gi
    accessMode: ReadWriteMany  # Requer storage class que suporte RWX
  apps:
    enabled: true
    size: 10Gi
    accessMode: ReadWriteMany
----

NOTE: O local-path-provisioner padrão do k3s não suporta ReadWriteMany. Use NFS ou outro storage class.

=== Limites de Recursos

[source,yaml]
----
# Adicionar ao deployment via values ou overlay
resources:
  requests:
    cpu: 500m
    memory: 256Mi
  limits:
    cpu: "2"
    memory: 1Gi
----

=== Variáveis de Ambiente Customizadas

[source,yaml]
----
buntime:
  port: 8000
  poolSize: 200
  logLevel: "debug"
  # Variáveis adicionais via ConfigMap
----

== Referência Rápida

[cols="1,2"]
|===
| Ação | Comando

| Instalar
| `helm install buntime ./charts/buntime -n buntime -f values-k3s.yaml`

| Atualizar
| `helm upgrade buntime ./charts/buntime -n buntime -f values-k3s.yaml`

| Desinstalar
| `helm uninstall buntime -n buntime`

| Ver status
| `helm status buntime -n buntime`

| Ver pods
| `kubectl get pods -n buntime`

| Ver logs
| `kubectl logs -n buntime -l app.kubernetes.io/name=buntime -f`

| Restart pods
| `kubectl rollout restart deployment -n buntime buntime`

| Shell no pod
| `kubectl exec -n buntime -it deployment/buntime -- sh`
|===
