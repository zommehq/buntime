== Kubernetes / OKD

Buntime provides a Helm chart for deployment on Kubernetes and OpenShift/OKD.

=== Prerequisites

* Kubernetes 1.19+ or OpenShift/OKD 4.x
* Helm 3.x
* `kubectl` or `oc` CLI

=== Quick Start

[source,bash]
----
# Clone the repository
git clone https://github.com/djalmajr/buntime.git
cd buntime

# Install with Helm
helm install buntime charts/buntime
----

=== Installation Methods

==== NodePort (Default)

Best for local testing and development clusters:

[source,bash]
----
helm install buntime charts/buntime

# Get access URL
export NODE_PORT=$(kubectl get svc buntime -o jsonpath='{.spec.ports[0].nodePort}')
export NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[0].address}')
echo http://$NODE_IP:$NODE_PORT
----

==== Ingress (Kubernetes)

For production with an Ingress controller:

[source,bash]
----
helm install buntime charts/buntime \
  --set ingress.enabled=true \
  --set ingress.className=nginx \
  --set ingress.host=buntime.example.com
----

With TLS:

[source,bash]
----
helm install buntime charts/buntime \
  --set ingress.enabled=true \
  --set ingress.className=nginx \
  --set ingress.host=buntime.example.com \
  --set ingress.tls.enabled=true \
  --set ingress.tls.secretName=buntime-tls
----

With path prefix (rewrite enabled automatically):

[source,bash]
----
helm install buntime charts/buntime \
  --set ingress.enabled=true \
  --set ingress.className=nginx \
  --set ingress.host=example.com \
  --set ingress.path=/b
----

With wildcard host and existing TLS secret:

[source,bash]
----
helm install buntime charts/buntime \
  --set ingress.enabled=true \
  --set ingress.className=nginx \
  --set 'ingress.host=*.cloud4biz.com' \
  --set ingress.path=/b \
  --set ingress.tls.enabled=true \
  --set ingress.tls.secretName=cert-cloud4biz
----

NOTE: When using `ingress.path` with a value other than `/`, the chart automatically adds nginx rewrite annotations to strip the prefix before forwarding to the backend.

==== Route (OpenShift/OKD)

For OpenShift/OKD environments:

[source,bash]
----
helm install buntime charts/buntime \
  --set route.enabled=true \
  --set route.host=buntime.apps.mycluster.com
----

=== Configuration

==== values.yaml

[source,yaml]
----
replicaCount: 1

image:
  repository: ghcr.io/djalmajr/buntime
  tag: latest
  pullPolicy: Always

service:
  type: NodePort
  port: 8000

# Kubernetes Ingress
ingress:
  enabled: false
  className: ""
  host: ""
  path: "/"  # Use "/b" for path-based routing (auto-rewrite)
  annotations: {}
  tls:
    enabled: false
    secretName: ""

# OpenShift/OKD Route
route:
  enabled: false
  host: ""
  tls:
    enabled: true
    termination: edge

# Buntime configuration
buntime:
  port: 8000
  poolSize: 100
  workspaces: "/app/apps"
  libsqlUrl: ""
  logLevel: "info"

# Plugins (generates buntime.jsonc)
plugins:
  metrics:
    enabled: true
  deployments:
    enabled: true
  database:
    enabled: false
  keyval:
    enabled: false
  health:
    enabled: false

# External LibSQL
libsql:
  externalUrl: ""
----

==== Common Configurations

===== Basic Deployment

[source,bash]
----
helm install buntime charts/buntime \
  --set replicaCount=2 \
  --set buntime.poolSize=200
----

===== With Database Plugins

[source,bash]
----
helm install buntime charts/buntime \
  --set plugins.database.enabled=true \
  --set plugins.keyval.enabled=true \
  --set buntime.libsqlUrl=http://libsql:8080
----

===== Custom Image

[source,bash]
----
helm install buntime charts/buntime \
  --set image.repository=myregistry.io/buntime \
  --set image.tag=v1.2.3
----

=== Architecture

==== Resources Created

[cols="1,2"]
|===
| Resource | Description

| Deployment
| Buntime pods with health probes

| Service
| ClusterIP/NodePort for internal access

| ConfigMap (env)
| Environment variables (PORT, POOL_SIZE, etc)

| ConfigMap (config)
| buntime.jsonc with plugin configuration

| Ingress (optional)
| External HTTP/HTTPS access

| Route (optional)
| OpenShift Route for external access
|===

==== Pod Configuration

The deployment creates pods with:

* **Health Probes**: Liveness and readiness checks on `/api/plugins`
* **Config Mount**: buntime.jsonc mounted at `/app/buntime.jsonc`
* **Env Vars**: Loaded from ConfigMap via `envFrom`

=== Operations

==== View Logs

[source,bash]
----
kubectl logs -f deployment/buntime
----

==== Check Configuration

[source,bash]
----
# View environment ConfigMap
kubectl get configmap buntime -o yaml

# View buntime.jsonc ConfigMap
kubectl get configmap buntime-config -o yaml
----

==== Scale

[source,bash]
----
kubectl scale deployment buntime --replicas=3
----

==== Upgrade

[source,bash]
----
helm upgrade buntime charts/buntime \
  --set image.tag=v2.0.0
----

==== Uninstall

[source,bash]
----
helm uninstall buntime
----

=== LibSQL Deployment

If using database plugins, deploy LibSQL alongside Buntime:

[source,yaml]
----
# libsql-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: libsql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: libsql
  template:
    metadata:
      labels:
        app: libsql
    spec:
      containers:
        - name: libsql
          image: ghcr.io/tursodatabase/libsql-server:latest
          ports:
            - containerPort: 8080
          env:
            - name: SQLD_NODE
              value: primary
            - name: SQLD_DISABLE_AUTH
              value: "true"
          volumeMounts:
            - name: data
              mountPath: /var/lib/sqld
      volumes:
        - name: data
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: libsql
spec:
  selector:
    app: libsql
  ports:
    - port: 8080
      targetPort: 8080
----

Then configure Buntime:

[source,bash]
----
helm install buntime charts/buntime \
  --set plugins.database.enabled=true \
  --set buntime.libsqlUrl=http://libsql:8080
----

=== Troubleshooting

==== Pod Not Starting

Check events:

[source,bash]
----
kubectl describe pod -l app=buntime
----

Common issues:

* Image pull error: Check image repository and credentials
* Probe failures: Check if `/api/plugins` endpoint works
* Config error: Check ConfigMaps for valid configuration

==== Plugin Load Failures

Check logs for plugin errors:

[source,bash]
----
kubectl logs -l app=buntime | grep -i plugin
----

==== Connection Refused

Verify service is running:

[source,bash]
----
kubectl get svc buntime
kubectl get endpoints buntime
----

=== Production Recommendations

==== Resource Limits

Add resource limits in production:

[source,yaml]
----
# values-production.yaml
replicaCount: 3

buntime:
  poolSize: 500

# Add to deployment manually or extend chart
resources:
  limits:
    cpu: "2"
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 256Mi
----

==== High Availability

[source,bash]
----
helm install buntime charts/buntime \
  --set replicaCount=3 \
  --set buntime.poolSize=200
----

==== Monitoring

Enable metrics plugin and scrape with Prometheus:

[source,bash]
----
helm install buntime charts/buntime \
  --set plugins.metrics.enabled=true
----

Prometheus ServiceMonitor (if using Prometheus Operator):

[source,yaml]
----
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: buntime
spec:
  selector:
    matchLabels:
      app: buntime
  endpoints:
    - port: http
      path: /api/metrics/prometheus
      interval: 30s
----
