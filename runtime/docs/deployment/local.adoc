= Execução Local
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

Existem três formas de executar o Buntime localmente:

[cols="1,1,2,1"]
|===
| Modo | Comando | Caso de Uso | Tamanho

| Development
| `bun dev`
| Hot reload, debugging
| N/A

| Bundle
| `bun run index.ts`
| Semelhante a produção, requer Bun
| ~1.5MB

| Compiled
| `./buntime`
| Binary standalone, sem dependências
| ~130MB
|===

== Modo Development

[source,bash]
----
cd runtime
bun dev
----

Recursos:

* Hot reload em alterações de arquivos
* Source maps para debugging
* Inicialização mais lenta (plugins carregados de node_modules)

== Modo Bundle

Compile e execute o JavaScript empacotado:

[source,bash]
----
cd runtime

# Build bundle
bun run build

# Run with Bun
bun run dist/index.ts
----

Estrutura de saída:

[source]
----
dist/
├── index.ts       # Main bundle (~1.3MB)
└── wrapper.ts     # Worker thread (~23KB)
----

== Binary Compilado

Compile um executável standalone com todas as dependências embutidas:

[source,bash]
----
cd runtime

# Build binary
bun run build:bin

# Run directly
./dist/buntime
----

Saída:

[source]
----
dist/
└── buntime        # Standalone binary (~130MB)
----

=== Recursos do Modo Compiled

* Não requer instalação do Bun
* Todos os plugins embutidos no binary
* Deploy de arquivo único
* Funciona em qualquer sistema Linux x64

=== Configuração no Modo Compiled

O binary é configurado via variáveis de ambiente:

[source,bash]
----
# Option 1: Run with env vars
WORKER_DIRS=/apps PLUGIN_DIRS=/plugins ./dist/buntime

# Option 2: Use .env file
cd /opt/buntime
cp .env.example .env  # Configure env vars
./buntime
----

=== Variáveis de Ambiente

[source,bash]
----
# Required
export WORKER_DIRS=/path/to/apps

# Optional (defaults: PORT=8000, POOL_SIZE=500 for prod)
export PORT=8000
export POOL_SIZE=500
export LOG_LEVEL=info
export LIBSQL_URL=http://localhost:8880

# Run
./buntime
----

=== Serviço Systemd

Crie `/etc/systemd/system/buntime.service`:

[source,ini]
----
[Unit]
Description=Buntime Runtime
After=network.target

[Service]
Type=simple
User=buntime
Group=buntime
WorkingDirectory=/opt/buntime
ExecStart=/opt/buntime/buntime
Restart=always
RestartSec=5

Environment=PORT=8000
Environment=WORKER_DIRS=/opt/buntime/apps
Environment=LIBSQL_URL=http://localhost:8880
Environment=LOG_LEVEL=info

[Install]
WantedBy=multi-user.target
----

Habilite e inicie:

[source,bash]
----
sudo systemctl daemon-reload
sudo systemctl enable buntime
sudo systemctl start buntime
sudo systemctl status buntime
----

== Docker

=== Construir Imagem

[source,bash]
----
# From project root
docker build -t buntime:latest .
----

=== Executar Container

[source,bash]
----
docker run -d \
  --name buntime \
  -p 8000:8000 \
  -v /path/to/apps:/app/apps \
  -e WORKER_DIRS=/app/apps \
  -e LIBSQL_URL=http://host.docker.internal:8880 \
  buntime:latest
----

=== Docker Compose

[source,yaml]
----
services:
  buntime:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8001:8000"
    volumes:
      - ./tmp:/app/apps
    environment:
      PORT: 8000
      LIBSQL_URL: http://libsql:8080
      WORKER_DIRS: /app/apps
    depends_on:
      libsql:
        condition: service_healthy
    restart: unless-stopped

  libsql:
    image: ghcr.io/tursodatabase/libsql-server:latest
    ports:
      - "8880:8080"  # HTTP API
      - "8881:5001"  # gRPC API (for replication)
    volumes:
      - libsql-data:/var/lib/sqld
    environment:
      SQLD_NODE: primary
      SQLD_HTTP_LISTEN_ADDR: 0.0.0.0:8080
      SQLD_GRPC_LISTEN_ADDR: 0.0.0.0:5001
      SQLD_DISABLE_AUTH: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  libsql-replica:
    image: ghcr.io/tursodatabase/libsql-server:latest
    ports:
      - "8882:8080"  # HTTP API (replica)
    volumes:
      - libsql-replica-data:/var/lib/sqld
    environment:
      SQLD_NODE: replica
      SQLD_PRIMARY_URL: http://libsql:5001
      SQLD_HTTP_LISTEN_ADDR: 0.0.0.0:8080
      SQLD_DISABLE_AUTH: "true"
    depends_on:
      libsql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

volumes:
  libsql-data:
  libsql-replica-data:
----

NOTE: O docker-compose.yml usa `build:` para construir a imagem localmente. Para produção, você pode substituir por `image: ghcr.io/djalmajr/buntime:latest`.

== Comparação

[cols="1,1,1,1,1"]
|===
| Recurso | Dev | Bundle | Compiled | Docker

| Hot Reload
| Sim
| Não
| Não
| Não

| Requer Bun
| Sim
| Sim
| Não
| Não

| Tamanho do Deploy
| N/A
| ~1.5MB + Bun
| ~130MB
| ~132MB

| Tempo de Inicialização
| Lento
| Rápido
| Rápido
| Rápido

| Plugins de
| node_modules
| Embedded
| Embedded
| Embedded
|===
