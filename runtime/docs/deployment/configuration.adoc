= Configuração
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

== Visão Geral

O runtime utiliza configuração em camadas:

[cols="1,1,2"]
|===
| Nível | Arquivo/Fonte | Propósito

| Runtime
| Variáveis de ambiente
| Configuração global (poolSize, workerDirs, pluginDirs)

| Plugins
| `manifest.jsonc`
| Metadata e configuração de cada plugin

| Workers/Apps
| `manifest.jsonc`
| Configuração individual de cada aplicação

| Build-time
| `bunfig.toml`
| Plugins de build do Bun (i18next, iconify, TSR, Tailwind)

| UI
| `components.json`
| Configuração do Shadcn UI
|===

== Configuração do Runtime (Variáveis de Ambiente)

O runtime é configurado exclusivamente via variáveis de ambiente. Não há arquivo de configuração para o runtime.

=== Variáveis Disponíveis

[cols="1,1,1,2"]
|===
| Variável | Tipo | Default | Descrição

| `WORKER_DIRS`
| string (JSON array ou comma-separated)
| **Obrigatório**
| Diretórios de aplicações worker

| `PLUGIN_DIRS`
| string (JSON array ou comma-separated)
| `["./plugins"]`
| Diretórios de plugins

| `POOL_SIZE`
| number
| `500` (prod), `10` (dev), `5` (test)
| Tamanho máximo do worker pool

| `HOMEPAGE_APP`
| string
| -
| App para servir na raiz (opcional)

| `BODY_SIZE_DEFAULT`
| string
| `10mb`
| Limite padrão de body

| `BODY_SIZE_MAX`
| string
| `100mb`
| Limite máximo de body

| `PORT`
| number
| `8000`
| Porta do servidor

| `CONFIG_DIR`
| string
| `./data`
| Diretório para SQLite e configs persistentes

| `LOG_LEVEL`
| string
| `info`
| Nível de log (debug, info, warn, error)
|===

=== Exemplo de Configuração

[source,bash]
----
# .env
WORKER_DIRS=/apps,/external-apps
PLUGIN_DIRS=/plugins,/custom-plugins
POOL_SIZE=200
HOMEPAGE_APP=cpanel
PORT=8000
----

TIP: `WORKER_DIRS` e `PLUGIN_DIRS` aceitam JSON array (`["./apps", "./more"]`) ou caminhos separados por vírgula (`./apps,./more`).

== Configuração de Plugins (manifest.jsonc)

Cada plugin tem sua própria configuração em `manifest.jsonc` no diretório do plugin:

[source,jsonc]
----
// plugins/plugin-database/manifest.jsonc
{
  "name": "@buntime/plugin-database",
  "base": "/database",
  "entrypoint": "dist/client/index.html", // UI do plugin (se houver)
  "adapters": [
    {
      "type": "libsql",
      "urls": ["http://localhost:8880"]
    }
  ]
}
----

NOTE: O estado enabled/disabled é controlado pelo database (`buntime.db`), não pelo manifest. Use a CLI ou API para habilitar/desabilitar plugins.

=== Auto-Discovery de Plugins

Plugins são descobertos automaticamente dos diretórios em `PLUGIN_DIRS`.

==== Configuração por Plugin

Cada plugin tem seu próprio `manifest.jsonc` no diretório do plugin:

[source,jsonc]
----
// plugins/plugin-keyval/manifest.jsonc
{
  "name": "@buntime/plugin-keyval",
  "base": "/keyval",
  "dependencies": ["@buntime/plugin-database"],
  "entrypoint": "dist/client/index.html" // UI do plugin (se houver)
  // ... configurações específicas do plugin
}
----

==== Ordem de Resolução de Plugins

O runtime resolve plugins na seguinte ordem:

1. **Built-in plugins** - Embutidos no binário (sempre disponíveis)
2. **External plugins** - Descobertos de `pluginDirs`
3. **Node modules** - Do `node_modules` (apenas modo dev)

[source]
----
Plugin Resolution:
  1. Built-in: @buntime/plugin-metrics (embedded)
  2. External: ./plugins/plugin-keyval/plugin.ts
  3. Node modules: node_modules/@company/buntime-plugin-xyz
----

==== Dependências de Plugins

Plugins são automaticamente ordenados baseado em dependências usando ordenação topológica. Plugins definem suas dependências em `manifest.jsonc`:

[source,jsonc]
----
// plugins/plugin-keyval/manifest.jsonc
{
  "name": "@buntime/plugin-keyval",
  "base": "/keyval",
  "dependencies": ["@buntime/plugin-database"],  // Obrigatório
  "optionalDependencies": []                     // Opcional
}
----

IMPORTANT: Se um plugin declara dependências obrigatórias, essas dependências devem estar habilitadas no database. Use a CLI ou API para habilitar plugins.

==== Configuração Específica de Plugins

Cada plugin possui suas próprias opções de configuração em seu `manifest.jsonc`. Exemplos:

[source,jsonc]
----
// plugins/plugin-database/manifest.jsonc
{
  "name": "@buntime/plugin-database",
  "base": "/database",
  "adapters": [
    {
      "type": "libsql",
      "urls": ["${LIBSQL_URL}"]  // Environment variable interpolation
    }
  ]
}
----

[source,jsonc]
----
// plugins/plugin-gateway/manifest.jsonc
{
  "name": "@buntime/plugin-gateway",
  "base": "/gateway",
  "rateLimit": {
    "requests": 100,
    "window": "1m",
    "keyBy": "ip"
  },
  "cache": {
    "ttl": 300,
    "methods": ["GET"]
  }
}
----

[source,jsonc]
----
// plugins/plugin-proxy/manifest.jsonc
{
  "name": "@buntime/plugin-proxy",
  "base": "/proxy",
  "rules": [
    {
      "name": "CPanel App",
      "pattern": "^/cpanel(/.*)?$",
      "target": "http://localhost:4000",
      "rewrite": "$1",
      "changeOrigin": true,
      "ws": true
    }
  ]
}
----

=== Interpolação de Variáveis de Ambiente

O runtime suporta interpolação de variáveis de ambiente em valores de configuração usando a sintaxe `${VAR_NAME}`:

[source,jsonc]
----
// plugins/plugin-database/manifest.jsonc
{
  "name": "@buntime/plugin-database",
  "base": "/database",
  "adapters": [
    {
      "type": "libsql",
      "urls": ["${LIBSQL_URL}"]  // Replaced with process.env.LIBSQL_URL
    }
  ]
}
----

TIP: Isso permite que o mesmo arquivo de configuração funcione em ambientes de development, staging e production alterando apenas o arquivo `.env`.

== Configuração de Workers

=== Localização da Configuração

Workers são configurados via arquivo `manifest.jsonc` no diretório da aplicação.

[source,jsonc]
----
// apps/todos-kv/manifest.jsonc
{
  "entrypoint": "dist/index.js",
  "idleTimeout": 30,
  "lowMemory": false,
  "maxRequests": 100,
  "timeout": 30,
  "ttl": 60
}
----

=== Opções de Worker

==== entrypoint

Arquivo de entrada para a aplicação worker.

[cols="1,2"]
|===
| Type | `string`

| Padrão
| `index.ts` ou campo main do package.json

| Exemplo
| `"dist/index.js"`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "entrypoint": "dist/index.js"  // Use built output
}
----

==== autoInstall

Executa `bun install --frozen-lockfile` antes de iniciar o worker.

[cols="1,2"]
|===
| Type | `boolean`

| Padrão
| `false`

| Exemplo
| `true`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "autoInstall": true  // Install dependencies before worker starts
}
----

==== env

Variáveis de ambiente adicionais para passar ao worker.

[cols="1,2"]
|===
| Type | `Record<string, string>`

| Padrão
| Nenhum

| Exemplo
| `{ "API_KEY": "abc123", "DEBUG": "true" }`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "env": {
    "API_KEY": "abc123",
    "DEBUG": "true"
  }
}
----

==== publicRoutes

Define rotas públicas que ignoram autenticação.

[cols="1,2"]
|===
| Type | Array ou object

| Padrão
| Nenhum

| Exemplo
| Consulte a documentação do plugin para o formato
|===

[source,jsonc]
----
// manifest.jsonc
{
  "publicRoutes": [
    "/health",
    "/public/*"
  ]
}
----

NOTE: O formato exato depende do plugin de autenticação sendo utilizado. Consulte a documentação do plugin para detalhes.

==== idleTimeout

Tempo em segundos antes de um worker ocioso ser terminado.

[cols="1,2"]
|===
| Type | `number`

| Padrão
| `60`

| Exemplo
| `60`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "idleTimeout": 60  // Termina worker após 60 segundos de inatividade
}
----

==== lowMemory

Habilita modo de baixa memória (restringe uso de memória do worker).

[cols="1,2"]
|===
| Type | `boolean`

| Padrão
| `false`

| Exemplo
| `false`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "lowMemory": false  // Modo de memória normal
}
----

==== maxBodySize

Limite de tamanho de body para este worker específico. Se não definido, usa o `bodySize.default` global.

[cols="1,2"]
|===
| Type | `number \| string`

| Padrão
| `bodySize.default` global (10mb)

| Máximo
| `bodySize.max` global (100mb)

| Exemplo
| `"50mb"` ou `52428800`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "maxBodySize": "50mb"  // Aceita uploads até 50MB neste worker
}
----

Formatos aceitos: número em bytes ou string com unidade (`"10mb"`, `"1gb"`).

WARNING: Se `maxBodySize` exceder o `bodySize.max` global, o runtime irá logar um warning e utilizar o valor máximo.

==== maxRequests

Número máximo de requisições que um worker pode processar antes de ser reciclado.

[cols="1,2"]
|===
| Type | `number`

| Padrão
| `1000`

| Exemplo
| `1000`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "maxRequests": 1000  // Recicla worker após 1000 requisições
}
----

IMPORTANT: Workers são reciclados para prevenir memory leaks e garantir performance consistente ao longo do tempo.

==== timeout

Tempo máximo em segundos para uma única requisição.

[cols="1,2"]
|===
| Type | `number`

| Padrão
| `30`

| Exemplo
| `30`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "timeout": 30  // Encerra requisição após 30 segundos
}
----

==== ttl

Tempo de vida em segundos para a instância do worker.

[cols="1,2"]
|===
| Type | `number`

| Padrão
| `0` (sem limite de TTL)

| Exemplo
| `60`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "ttl": 60  // Termina worker após 60 segundos independente de atividade
}
----

NOTE: Quando definido como `0` (padrão), workers não têm limite de TTL e serão terminados apenas baseado em `idleTimeout` ou `maxRequests`.

==== visibility (plugin-deployments)

Controla a visibilidade da aplicação na UI de deployments. Este campo é lido pelo `plugin-deployments`, não pelo runtime core.

[cols="1,2"]
|===
| Type | `"public" \| "protected" \| "internal"`

| Padrão
| `"public"`

| Exemplo
| `"protected"`
|===

[source,jsonc]
----
// manifest.jsonc
{
  "visibility": "protected"
}
----

Valores:

- `public`: Visível e editável (padrão)
- `protected`: Visível mas somente leitura
- `internal`: Oculta do browser de deployments

NOTE: Este campo não faz parte do schema de worker config do runtime. É processado exclusivamente pelo `@buntime/plugin-deployments`. Deve ser adicionado ao `manifest.jsonc` do worker.

== Plugins de Build-Time (bunfig.toml)

O cliente do runtime (React dashboard) utiliza plugins do Bun para transformações em build-time:

[source,toml]
----
[serve.static]
plugins = [
  "@zomme/bun-plugin-tsr",       # TanStack Router generation
  "@zomme/bun-plugin-iconify",   # Icon collection
  "@zomme/bun-plugin-i18next",   # Translation loading
  "bun-plugin-tailwind",         # Tailwind CSS
]

[plugins.tsr]
rootDirectory = "client"

[plugins.iconify]
dirs = ["client"]

[plugins.i18next]
dirs = "client"
----

=== Plugins Disponíveis

[cols="1,2"]
|===
| Plugin | Propósito

| `@zomme/bun-plugin-tsr`
| Gera rotas TanStack Router a partir da estrutura de arquivos

| `@zomme/bun-plugin-iconify`
| Fornece coleções de ícones via componente Icon

| `@zomme/bun-plugin-i18next`
| Carrega traduções de arquivos JSON colocalizados

| `bun-plugin-tailwind`
| Processamento de Tailwind CSS
|===

Consulte a documentação do plugin para opções de configuração detalhadas.

== Variáveis de Ambiente (.env)

O runtime carrega variáveis de ambiente do `.env` no diretório de trabalho atual:

[source,bash]
----
/Users/djalmajr/Developer/zomme/buntime/
└── runtime/
    ├── .env      # Environment variables (runtime configuration)
    └── index.ts
----

NOTE: Todas as configurações do runtime são feitas via variáveis de ambiente. Veja a seção <<Configuração do Runtime (Variáveis de Ambiente)>> para a lista completa.

=== Variáveis de Plugins

Plugins podem requerer variáveis de ambiente adicionais:

[cols="1,2,1"]
|===
| Variável | Descrição | Plugin

| `LIBSQL_URL`
| URL do servidor libSQL
| plugin-database, plugin-keyval

| `KEYCLOAK_URL`
| URL do servidor Keycloak
| plugin-authn
|===

=== Exemplo de Configuração Completa

[source,bash]
----
# Runtime Configuration
WORKER_DIRS=/apps,/external-apps
PLUGIN_DIRS=/plugins
POOL_SIZE=200
HOMEPAGE_APP=cpanel
PORT=8000
LOG_LEVEL=info

# libSQL database URL (for plugins that use KeyVal storage)
# Options:
#   - Docker/remote: http://localhost:8880 (recommended)
#   - Local file: file:/absolute/path/to/buntime.db
# Note: Relative paths don't work with compiled binaries
LIBSQL_URL=http://localhost:8880
----

IMPORTANT: Ao usar URLs `file:` para libSQL, sempre use caminhos absolutos. Caminhos relativos falham em binários compilados.

== Configuração do Shadcn UI (components.json)

O dashboard do runtime utiliza componentes Shadcn UI. A configuração está em `components.json`:

[source,json]
----
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "index.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "~/components",
    "utils": "~/utils/cn",
    "ui": "~/components/ui",
    "lib": "~/libs",
    "hooks": "~/hooks"
  }
}
----

Esta configuração é utilizada pela CLI `shadcn` ao adicionar novos componentes:

[source,bash]
----
npx shadcn add button
----

== Exemplo Completo de Configuração

=== Development

[source,bash]
----
# .env (runtime configuration)
WORKER_DIRS=../../buntime-apps,../examples
PLUGIN_DIRS=./plugins
POOL_SIZE=10  # default for development
PORT=8000
LIBSQL_URL=http://localhost:8880
----

[source,jsonc]
----
// plugins/plugin-database/manifest.jsonc
{
  "name": "@buntime/plugin-database",
  "base": "/database",
  "adapters": [
    {
      "type": "libsql",
      "urls": ["http://localhost:8880"]
    }
  ]
}
----

[source,jsonc]
----
// plugins/plugin-keyval/manifest.jsonc
{
  "name": "@buntime/plugin-keyval",
  "base": "/keyval",
  "dependencies": ["@buntime/plugin-database"]
}
----

[source,jsonc]
----
// plugins/plugin-metrics/manifest.jsonc
{
  "name": "@buntime/plugin-metrics",
  "base": "/metrics"
}
----

NOTE: Use a CLI (`buntime-cli`) ou API (`PUT /api/core/plugins/:name/enable`) para habilitar plugins após a instalação.

=== Production

[source,bash]
----
# .env (runtime configuration)
WORKER_DIRS=/data/apps
PLUGIN_DIRS=/data/plugins
POOL_SIZE=500
PORT=8000
LOG_LEVEL=info
LIBSQL_URL=${LIBSQL_URL}
LIBSQL_TOKEN=${LIBSQL_TOKEN}
----

[source,jsonc]
----
// plugins/plugin-database/manifest.jsonc
{
  "name": "@buntime/plugin-database",
  "base": "/database",
  "adapters": [
    {
      "type": "libsql",
      "urls": ["${LIBSQL_URL}"],
      "authToken": "${LIBSQL_TOKEN}"
    }
  ]
}
----

[source,jsonc]
----
// plugins/plugin-keyval/manifest.jsonc
{
  "name": "@buntime/plugin-keyval",
  "base": "/keyval",
  "dependencies": ["@buntime/plugin-database"],
  "queue": {
    "cleanupInterval": 300000,
    "lockDuration": 60000
  },
  "metrics": {
    "persistent": true,
    "flushInterval": 30000
  }
}
----

[source,jsonc]
----
// plugins/plugin-gateway/manifest.jsonc
{
  "name": "@buntime/plugin-gateway",
  "base": "/gateway",
  "rateLimit": {
    "requests": 1000,
    "window": "1m",
    "keyBy": "ip"
  },
  "cache": {
    "ttl": 300,
    "methods": ["GET"],
    "maxEntries": 10000
  },
  "cors": {
    "origin": "https://app.example.com",
    "credentials": true
  }
}
----

[source,jsonc]
----
// plugins/plugin-authn/manifest.jsonc
{
  "name": "@buntime/plugin-authn",
  "base": "/authn",
  "dependencies": ["@buntime/plugin-database"],
  "provider": "keycloak",
  "issuer": "${KEYCLOAK_URL}",
  "realm": "${KEYCLOAK_REALM}",
  "clientId": "${KEYCLOAK_CLIENT_ID}",
  "excludePaths": ["/health", "/metrics"]
}
----

[source,jsonc]
----
// plugins/plugin-authz/manifest.jsonc
{
  "name": "@buntime/plugin-authz",
  "base": "/authz",
  "dependencies": ["@buntime/plugin-database"],
  "store": "database",
  "combiningAlgorithm": "deny-overrides"
}
----

[source,bash]
----
# .env
NODE_ENV=production
PORT=8000
WORKER_DIRS=/app/buntime-apps

# Database
LIBSQL_URL=http://libsql:8080
LIBSQL_TOKEN=<jwt-token>
LIBSQL_REPLICA_URL=http://libsql-replica:8080

# Authentication
KEYCLOAK_URL=https://auth.example.com
KEYCLOAK_REALM=production
KEYCLOAK_CLIENT_ID=buntime
----

== Validação de Configuração

O runtime valida a configuração na inicialização e fornece mensagens de erro úteis:

[source]
----
# Missing required plugin dependency
Error: Plugin "@buntime/plugin-proxy" requires "@buntime/plugin-keyval" which is not available.
Ensure "@buntime/plugin-keyval" is installed in pluginDirs.

# Circular dependency
Error: Circular dependency detected among plugins: @buntime/plugin-a, @buntime/plugin-b

# Invalid plugin manifest.jsonc
Error: Plugin "plugin-keyval" manifest is missing required field: name

# Plugin disabled
[DEBUG] Skipping disabled plugin: @buntime/plugin-example
----

== Boas Práticas de Configuração

=== Use Variáveis de Ambiente

Armazene dados sensíveis em `.env`, não em `manifest.jsonc`:

[source,jsonc]
----
// WRONG - hardcoded secrets
// plugins/plugin-database/manifest.jsonc
{
  "name": "@buntime/plugin-database",
  "base": "/database",
  "adapters": [
    {
      "type": "libsql",
      "urls": ["http://production-db:8080"],
      "authToken": "secret-token-here"  // NEVER do this
    }
  ]
}
----

[source,jsonc]
----
// CORRECT - use environment variables
// plugins/plugin-database/manifest.jsonc
{
  "name": "@buntime/plugin-database",
  "base": "/database",
  "adapters": [
    {
      "type": "libsql",
      "urls": ["${LIBSQL_URL}"],
      "authToken": "${LIBSQL_TOKEN}"
    }
  ]
}
----

=== Separe Responsabilidades

Use diferentes arquivos de configuração para diferentes propósitos:

- **.env** - Configuração do runtime (workerDirs, poolSize, etc)
- **plugins/*/manifest.jsonc** - Manifesto individual de cada plugin (metadata + config)
- **apps/*/manifest.jsonc** - Configuração individual de cada worker/app
- **bunfig.toml** - Transformações de build-time (plugins do Bun)
- **components.json** - Configuração do framework de UI

=== Documente Plugins Customizados

Se estiver usando plugins externos customizados, documente-os no README do seu projeto:

[source,bash]
----
plugins/
├── my-plugin/
│   ├── manifest.jsonc  # Plugin manifest
│   ├── plugin.ts       # Plugin implementation
│   └── README.md       # Document your plugin
----

=== Controle de Versão

Adicione ao `.gitignore`:

[source]
----
# Arquivos de ambiente (secrets)
.env
.env.local

# Manter exemplos
!.env.example
----

Commitar no controle de versão:

[source]
----
# Configuração (sem secrets)
bunfig.toml
components.json
.env.example
plugins/*/manifest.jsonc
----
