== Configuração
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

=== Visão Geral

O runtime utiliza três arquivos de configuração principais:

[cols="1,1,2"]
|===
| Arquivo | Propósito | Formato

| `buntime.jsonc`
| Configuração do runtime, plugins, settings do pool
| JSONC (comentários permitidos)

| `bunfig.toml`
| Plugins de build-time do Bun (i18next, iconify, TSR, Tailwind)
| TOML

| `.env`
| Variáveis de ambiente
| ENV

| `components.json`
| Configuração do Shadcn UI
| JSON
|===

Além disso, aplicações worker podem especificar configuração via o campo `buntime` em seu `package.json`.

=== Configuração do Runtime (buntime.jsonc)

==== Localização do Arquivo

O runtime procura por `buntime.jsonc` no diretório de trabalho atual:

[source,bash]
----
/Users/djalmajr/Developer/zomme/buntime/
└── runtime/
    ├── buntime.jsonc       # Runtime configuration
    ├── index.ts            # Entry point
    └── server/
----

==== Formato de Configuração

A configuração utiliza formato de plugin estilo Babel, onde plugins podem ser especificados como strings ou tuplas:

[source,jsonc]
----
{
  // === Global Settings ===
  "workspaces": ["../../buntime-apps", "../examples"],  // Directories to scan for worker apps
  "poolSize": 100,                                      // Worker pool size
  "homepage": "cpanel",                                 // Optional: app to serve when no route matches

  // === Plugins ===
  "plugins": [
    // String format (no config)
    "@buntime/plugin-metrics",

    // Tuple format (with config)
    [
      "@buntime/plugin-database",
      {
        "adapters": [
          {
            "type": "libsql",
            "urls": ["http://localhost:8880"]
          }
        ]
      }
    ]
  ]
}
----

==== Configurações Globais

===== workspaces

Diretórios onde o runtime irá escanear por aplicações worker.

[cols="1,2"]
|===
| Type | `string[]`

| Padrão
| **Obrigatório** - Sem padrão, deve ser definido em buntime.jsonc ou na variável de ambiente WORKSPACES_DIR

| Exemplo
| `["../../buntime-apps", "../examples"]`
|===

O runtime escaneia esses diretórios por aplicações com arquivos `package.json` válidos e os carrega no worker pool.

[source,jsonc]
----
{
  "workspaces": [
    "../../buntime-apps",    // Production apps
    "../examples"            // Example apps
  ]
}
----

IMPORTANT: Os caminhos são relativos ao diretório que contém `buntime.jsonc`, não ao diretório de trabalho atual.

TIP: Você também pode usar a variável de ambiente WORKSPACES_DIR com caminhos separados por vírgula: `WORKSPACES_DIR=/dir1,/dir2,../dir3`

===== poolSize

Número máximo de workers no pool.

[cols="1,2"]
|===
| Type | `number`

| Padrão
a|
[cols="1,1"]
!===
! Ambiente ! Padrão

! Development
! `10`

! Production
! `500`

! Staging
! `50`

! Test
! `5`

! Outros
! `100` (fallback)
!===

| Exemplo
| `100`
|===

[source,jsonc]
----
{
  "poolSize": 100  // Support up to 100 concurrent workers
}
----

O tamanho do pool determina quantas instâncias de worker podem executar simultaneamente. Cada worker pode processar múltiplas requisições baseado em sua configuração `maxRequests`.

===== homepage

Aplicação opcional para servir quando nenhuma rota corresponder. Esta aplicação tipicamente orquestra micro-frontends via fragments.

[cols="1,2"]
|===
| Type | `string`

| Padrão
| Nenhum

| Exemplo
| `"cpanel"`
|===

[source,jsonc]
----
{
  "homepage": "cpanel"  // Serve cpanel app for unmatched routes
}
----

Quando definido, requisições que não correspondem a nenhuma rota de aplicação serão encaminhadas para esta aplicação. A aplicação homepage pode usar fragments para incorporar UIs de outros plugins.

[[body-size]]
===== bodySize

Tamanho máximo do corpo de requisições aceito pelo runtime. Esta é uma configuração global que se aplica a todas as requisições.

[cols="1,2"]
|===
| Type | `number \| string`

| Padrão
| `10mb` (10485760 bytes)

| Máximo
| `100mb` (104857600 bytes)

| Exemplo
| `"50mb"` ou `52428800`
|===

[source,jsonc]
----
// buntime.jsonc (configuração global)
{
  "workspaces": ["../../buntime-apps"],
  "poolSize": 100,
  "bodySize": "50mb",  // Aceita uploads até 50MB
  "plugins": [
    "@buntime/plugin-metrics"
  ]
}
----

Formatos aceitos:

[cols="1,2"]
|===
| Formato | Exemplo

| Number (bytes)
| `10485760`

| String com unidade
| `"10mb"`, `"1gb"`, `"500kb"`
|===

Unidades suportadas: `b`, `kb`, `mb`, `gb`.

IMPORTANT: Requisições que excedem o limite recebem resposta `413 Payload Too Large`.

==== Configuração de Plugins

===== Formato de Plugin

Plugins utilizam configuração estilo Babel:

[source,jsonc]
----
{
  "plugins": [
    // String format: plugin with no configuration
    "@buntime/plugin-metrics",

    // Tuple format: [plugin-name, config-object]
    [
      "@buntime/plugin-keyval",
      {
        "libsqlUrl": "http://localhost:8880"
      }
    ]
  ]
}
----

===== Ordem de Resolução de Plugins

O runtime resolve plugins na seguinte ordem:

1. **Built-in plugins** - Embutidos no binário (sempre disponíveis)
2. **External plugins** - Do diretório `./plugins/`
3. **Node modules** - Do `node_modules` (apenas modo dev)

[source]
----
Plugin Resolution:
  1. Built-in: @buntime/plugin-metrics (embedded)
  2. External: ./plugins/my-plugin/index.ts
  3. Node modules: node_modules/@buntime/plugin-xyz
----

===== Dependências de Plugins

Plugins são automaticamente ordenados baseado em dependências usando ordenação topológica. Você não precisa ordenar plugins manualmente na configuração.

[source,jsonc]
----
{
  "plugins": [
    // These will be auto-sorted by the runtime:
    "@buntime/plugin-keyval",     // Has no dependencies
    "@buntime/plugin-proxy",      // Optional dependency on keyval
    "@buntime/plugin-metrics"     // Has no dependencies
  ]
}
----

IMPORTANT: Se um plugin declara dependências obrigatórias, elas devem estar presentes no array `plugins` ou o runtime lançará um erro.

===== Configuração Específica de Plugins

Cada plugin possui suas próprias opções de configuração. Consulte a documentação do plugin para detalhes:

[source,jsonc]
----
{
  "plugins": [
    // Database plugin
    [
      "@buntime/plugin-database",
      {
        "adapters": [
          {
            "type": "libsql",
            "urls": ["${LIBSQL_URL}"]  // Environment variable interpolation
          }
        ]
      }
    ],

    // Gateway plugin
    [
      "@buntime/plugin-gateway",
      {
        "rateLimit": {
          "requests": 100,
          "window": "1m",
          "keyBy": "ip"
        },
        "cache": {
          "ttl": 300,
          "methods": ["GET"]
        }
      }
    ],

    // Proxy plugin
    [
      "@buntime/plugin-proxy",
      {
        "rules": [
          {
            "name": "CPanel App",
            "pattern": "^/cpanel(/.*)?$",
            "target": "http://localhost:4000",
            "rewrite": "$1",
            "changeOrigin": true,
            "ws": true
          }
        ]
      }
    ],

    // Authentication plugin
    [
      "@buntime/plugin-authn",
      {
        "provider": "keycloak",
        "issuer": "${KEYCLOAK_URL}",
        "realm": "${KEYCLOAK_REALM}",
        "excludePaths": ["/health", "/public/.*"]
      }
    ],

    // Authorization plugin
    [
      "@buntime/plugin-authz",
      {
        "store": "file",
        "path": "./policies.json",
        "combiningAlgorithm": "deny-overrides",
        "policies": [
          {
            "id": "admin-all-access",
            "effect": "permit",
            "subjects": [{ "role": "admin" }],
            "resources": [{ "path": "*" }],
            "actions": [{ "method": "*" }]
          }
        ]
      }
    ]
  ]
}
----

==== Interpolação de Variáveis de Ambiente

O runtime suporta interpolação de variáveis de ambiente em valores de configuração usando a sintaxe `${VAR_NAME}`:

[source,jsonc]
----
{
  "plugins": [
    [
      "@buntime/plugin-database",
      {
        "adapters": [
          {
            "type": "libsql",
            "urls": ["${LIBSQL_URL}"]  // Replaced with process.env.LIBSQL_URL
          }
        ]
      }
    ]
  ]
}
----

TIP: Isso permite que o mesmo arquivo de configuração funcione em ambientes de development, staging e production alterando apenas o arquivo `.env`.

=== Configuração de Workers

==== Localização da Configuração

Workers podem ser configurados via o campo `buntime` em seu `package.json` ou em um arquivo `buntime.jsonc` no diretório da aplicação.

**Prioridade de configuração:**

1. Primeiro: `buntime.jsonc` no diretório da aplicação
2. Fallback: campo `buntime` no `package.json`

[source,json]
----
{
  "name": "todos-kv",
  "version": "2.0.0",
  "buntime": {
    "entrypoint": "dist/index.js",
    "idleTimeout": 30,
    "lowMemory": false,
    "maxRequests": 100,
    "timeout": 30,
    "ttl": 60
  }
}
----

==== Opções de Worker

===== entrypoint

Arquivo de entrada para a aplicação worker.

[cols="1,2"]
|===
| Type | `string`

| Padrão
| `index.ts` ou campo main do package.json

| Exemplo
| `"dist/index.js"`
|===

[source,json]
----
{
  "buntime": {
    "entrypoint": "dist/index.js"  // Use built output
  }
}
----

===== autoInstall

Executa `bun install --frozen-lockfile` antes de iniciar o worker.

[cols="1,2"]
|===
| Type | `boolean`

| Padrão
| `false`

| Exemplo
| `true`
|===

[source,json]
----
{
  "buntime": {
    "autoInstall": true  // Install dependencies before worker starts
  }
}
----

===== env

Variáveis de ambiente adicionais para passar ao worker.

[cols="1,2"]
|===
| Type | `Record<string, string>`

| Padrão
| Nenhum

| Exemplo
| `{ "API_KEY": "abc123", "DEBUG": "true" }`
|===

[source,json]
----
{
  "buntime": {
    "env": {
      "API_KEY": "abc123",
      "DEBUG": "true"
    }
  }
}
----

===== publicRoutes

Define rotas públicas que ignoram autenticação.

[cols="1,2"]
|===
| Type | Array ou object

| Padrão
| Nenhum

| Exemplo
| Consulte a documentação do plugin para o formato
|===

[source,json]
----
{
  "buntime": {
    "publicRoutes": [
      "/health",
      "/public/*"
    ]
  }
}
----

NOTE: O formato exato depende do plugin de autenticação sendo utilizado. Consulte a documentação do plugin para detalhes.

===== idleTimeout

Tempo em segundos antes de um worker ocioso ser terminado.

[cols="1,2"]
|===
| Type | `number`

| Padrão
| `60`

| Exemplo
| `60`
|===

[source,json]
----
{
  "buntime": {
    "idleTimeout": 60  // Termina worker após 60 segundos de inatividade
  }
}
----

===== lowMemory

Habilita modo de baixa memória (restringe uso de memória do worker).

[cols="1,2"]
|===
| Type | `boolean`

| Padrão
| `false`

| Exemplo
| `false`
|===

[source,json]
----
{
  "buntime": {
    "lowMemory": false  // Modo de memória normal
  }
}
----

===== maxRequests

Número máximo de requisições que um worker pode processar antes de ser reciclado.

[cols="1,2"]
|===
| Type | `number`

| Padrão
| `1000`

| Exemplo
| `1000`
|===

[source,json]
----
{
  "buntime": {
    "maxRequests": 1000  // Recicla worker após 1000 requisições
  }
}
----

IMPORTANT: Workers são reciclados para prevenir memory leaks e garantir performance consistente ao longo do tempo.

===== timeout

Tempo máximo em segundos para uma única requisição.

[cols="1,2"]
|===
| Type | `number`

| Padrão
| `30`

| Exemplo
| `30`
|===

[source,json]
----
{
  "buntime": {
    "timeout": 30  // Encerra requisição após 30 segundos
  }
}
----

===== ttl

Tempo de vida em segundos para a instância do worker.

[cols="1,2"]
|===
| Type | `number`

| Padrão
| `0` (sem limite de TTL)

| Exemplo
| `60`
|===

[source,json]
----
{
  "buntime": {
    "ttl": 60  // Termina worker após 60 segundos independente de atividade
  }
}
----

NOTE: Quando definido como `0` (padrão), workers não têm limite de TTL e serão terminados apenas baseado em `idleTimeout` ou `maxRequests`.

===== visibility

Controla a visibilidade da aplicação na UI de deployments.

[cols="1,2"]
|===
| Type | `"public" \| "protected" \| "internal"`

| Padrão
| `"public"`

| Exemplo
| `"protected"`
|===

[source,json]
----
{
  "buntime": {
    "visibility": "protected"
  }
}
----

Valores:

- `public`: Visível e editável (padrão)
- `protected`: Visível mas somente leitura
- `internal`: Oculta do browser de deployments

=== Plugins de Build-Time (bunfig.toml)

O cliente do runtime (React dashboard) utiliza plugins do Bun para transformações em build-time:

[source,toml]
----
[serve.static]
plugins = [
  "@zomme/bun-plugin-tsr",       # TanStack Router generation
  "@zomme/bun-plugin-iconify",   # Icon collection
  "@zomme/bun-plugin-i18next",   # Translation loading
  "bun-plugin-tailwind",         # Tailwind CSS
]

[plugins.tsr]
rootDirectory = "client"

[plugins.iconify]
dirs = ["client"]

[plugins.i18next]
dirs = "client"
----

==== Plugins Disponíveis

[cols="1,2"]
|===
| Plugin | Propósito

| `@zomme/bun-plugin-tsr`
| Gera rotas TanStack Router a partir da estrutura de arquivos

| `@zomme/bun-plugin-iconify`
| Fornece coleções de ícones via componente Icon

| `@zomme/bun-plugin-i18next`
| Carrega traduções de arquivos JSON colocalizados

| `bun-plugin-tailwind`
| Processamento de Tailwind CSS
|===

Consulte a documentação do plugin para opções de configuração detalhadas.

=== Variáveis de Ambiente (.env)

==== Localização do Arquivo

O runtime carrega variáveis de ambiente do `.env` no diretório de trabalho atual:

[source,bash]
----
/Users/djalmajr/Developer/zomme/buntime/
└── runtime/
    ├── .env            # Environment variables
    ├── buntime.jsonc   # Runtime configuration
    └── index.ts
----

==== Variáveis Disponíveis

[cols="1,2,1"]
|===
| Variável | Descrição | Padrão

| `NODE_ENV`
| Ambiente (development, production)
| `development`

| `PORT`
| Porta do servidor
| `8000`

| `WORKSPACES_DIR`
| Diretório de aplicações worker
| (obrigatório)

| `POOL_SIZE`
| Sobrescreve tamanho do pool
| Dependente do ambiente

| `HOMEPAGE_APP`
| Sobrescreve aplicação homepage
| Nenhum

| `DELAY_MS`
| Delay de inicialização em ms
| `100`

| `LIBSQL_URL`
| URL do servidor libSQL (para plugins)
| Nenhum
|===

==== Exemplo de Configuração

[source,bash]
----
# Server settings
NODE_ENV=development
PORT=8000

# Apps directory (workspaces)
WORKSPACES_DIR=../../buntime-apps

# libSQL database URL (for plugins that use KeyVal storage)
# Options:
#   - Docker/remote: http://localhost:8880 (recommended)
#   - Local file: file:/absolute/path/to/buntime.db
# Note: Relative paths don't work with compiled binaries
LIBSQL_URL=http://localhost:8880
----

IMPORTANT: Ao usar URLs `file:` para libSQL, sempre use caminhos absolutos. Caminhos relativos falham em binários compilados.

=== Configuração do Shadcn UI (components.json)

O dashboard do runtime utiliza componentes Shadcn UI. A configuração está em `components.json`:

[source,json]
----
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "index.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "~/components",
    "utils": "~/utils/cn",
    "ui": "~/components/ui",
    "lib": "~/libs",
    "hooks": "~/hooks"
  }
}
----

Esta configuração é utilizada pela CLI `shadcn` ao adicionar novos componentes:

[source,bash]
----
npx shadcn add button
----

=== Exemplo Completo de Configuração

==== Development

[source,jsonc]
----
// buntime.jsonc
{
  "workspaces": ["../../buntime-apps", "../examples"],
  "poolSize": 100,
  "plugins": [
    "@buntime/plugin-metrics",
    "@buntime/plugin-deployments",
    "@buntime/plugin-health",
    "@buntime/plugin-logs",
    [
      "@buntime/plugin-database",
      {
        "adapters": [
          {
            "type": "libsql",
            "urls": ["http://localhost:8880"]
          }
        ]
      }
    ],
    "@buntime/plugin-keyval"
  ]
}
----

[source,bash]
----
# .env
NODE_ENV=development
PORT=8000
WORKSPACES_DIR=../../buntime-apps
LIBSQL_URL=http://localhost:8880
----

==== Production

[source,jsonc]
----
// buntime.jsonc
{
  "workspaces": ["${WORKSPACES_DIR}"],
  "poolSize": 500,
  "plugins": [
    "@buntime/plugin-metrics",
    "@buntime/plugin-deployments",
    "@buntime/plugin-health",
    "@buntime/plugin-logs",
    [
      "@buntime/plugin-database",
      {
        "adapters": [
          {
            "type": "libsql",
            "urls": ["${LIBSQL_URL}"],
            "authToken": "${LIBSQL_TOKEN}"
          }
        ]
      }
    ],
    [
      "@buntime/plugin-keyval",
      {
        "libsqlUrl": "${LIBSQL_URL}",
        "libsqlToken": "${LIBSQL_TOKEN}",
        "libsqlReplicaUrl": "${LIBSQL_REPLICA_URL}",
        "queue": {
          "cleanupInterval": 300000,
          "lockDuration": 60000
        },
        "metrics": {
          "persistent": true,
          "flushInterval": 30000
        }
      }
    ],
    [
      "@buntime/plugin-gateway",
      {
        "rateLimit": {
          "requests": 1000,
          "window": "1m",
          "keyBy": "ip"
        },
        "cache": {
          "ttl": 300,
          "methods": ["GET"],
          "maxEntries": 10000
        },
        "cors": {
          "origin": "https://app.example.com",
          "credentials": true
        }
      }
    ],
    [
      "@buntime/plugin-authn",
      {
        "provider": "keycloak",
        "issuer": "${KEYCLOAK_URL}",
        "realm": "${KEYCLOAK_REALM}",
        "clientId": "${KEYCLOAK_CLIENT_ID}",
        "excludePaths": ["/health", "/metrics"]
      }
    ],
    [
      "@buntime/plugin-authz",
      {
        "store": "database",
        "combiningAlgorithm": "deny-overrides"
      }
    ]
  ]
}
----

[source,bash]
----
# .env
NODE_ENV=production
PORT=8000
WORKSPACES_DIR=/app/buntime-apps

# Database
LIBSQL_URL=http://libsql:8080
LIBSQL_TOKEN=<jwt-token>
LIBSQL_REPLICA_URL=http://libsql-replica:8080

# Authentication
KEYCLOAK_URL=https://auth.example.com
KEYCLOAK_REALM=production
KEYCLOAK_CLIENT_ID=buntime
----

=== Validação de Configuração

O runtime valida a configuração na inicialização e fornece mensagens de erro úteis:

[source]
----
# Missing required plugin
Error: Plugin "@buntime/plugin-proxy" requires "@buntime/plugin-keyval" which is not configured.
Add "@buntime/plugin-keyval" to your buntime.jsonc plugins array.

# Circular dependency
Error: Circular dependency detected among plugins: @buntime/plugin-a, @buntime/plugin-b

# Invalid format
Error: [buntime.jsonc] Invalid plugin at index 2: expected string or [name, config] tuple
----

=== Boas Práticas de Configuração

==== Use Variáveis de Ambiente

Armazene dados sensíveis em `.env`, não em `buntime.jsonc`:

[source,jsonc]
----
// WRONG - hardcoded secrets
{
  "plugins": [
    [
      "@buntime/plugin-database",
      {
        "adapters": [
          {
            "type": "libsql",
            "urls": ["http://production-db:8080"],
            "authToken": "secret-token-here"  // NEVER do this
          }
        ]
      }
    ]
  ]
}

// CORRECT - use environment variables
{
  "plugins": [
    [
      "@buntime/plugin-database",
      {
        "adapters": [
          {
            "type": "libsql",
            "urls": ["${LIBSQL_URL}"],
            "authToken": "${LIBSQL_TOKEN}"
          }
        ]
      }
    ]
  ]
}
----

==== Separe Responsabilidades

Use diferentes arquivos de configuração para diferentes propósitos:

- **buntime.jsonc** - Comportamento do runtime (plugins, pool)
- **bunfig.toml** - Transformações de build-time (plugins do Bun)
- **.env** - Valores específicos do ambiente
- **components.json** - Configuração do framework de UI

==== Documente Plugins Customizados

Se estiver usando plugins externos customizados, documente-os no README do seu projeto:

[source,bash]
----
runtime/
├── buntime.jsonc
├── plugins/
│   ├── my-plugin/
│   │   ├── index.ts
│   │   └── README.md  # Document your plugin
----

==== Controle de Versão

Adicione ao `.gitignore`:

[source]
----
# Arquivos de ambiente (secrets)
.env
.env.local

# Manter exemplos
!.env.example
----

Commitar no controle de versão:

[source]
----
# Configuração (sem secrets)
buntime.jsonc
bunfig.toml
components.json
.env.example
----
