= Rotas da API
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 5
:icons: font
:source-highlighter: highlightjs

O servidor Buntime expõe dois grupos principais de rotas: plugins info API e worker routes.

NOTE: APIs específicas de plugins (como Deployments, KeyVal, Metrics) estão documentadas nos respectivos READMEs dos plugins em `plugins/plugin-*/README.adoc`.

== Plugins Info API

Retorna informações sobre todos os plugins carregados.

Base path: `/api/plugins`

=== GET /api/plugins

Lista todos os plugins carregados com suas configurações.

Exemplo:

[source,bash]
----
GET /api/plugins
----

Resposta:

[source,json]
----
[
  {
    "name": "@buntime/plugin-metrics",
    "base": "/metrics",
    "fragment": {
      "enabled": true,
      "type": "patch"
    },
    "menus": [
      {
        "title": "Metrics",
        "icon": "lucide:activity",
        "path": "/metrics",
        "priority": 5
      }
    ],
    "dependencies": [],
    "optionalDependencies": []
  },
  {
    "name": "@buntime/plugin-keyval",
    "base": "/keyval",
    "fragment": {
      "enabled": true,
      "type": "patch"
    },
    "menus": [
      {
        "title": "KeyVal",
        "icon": "lucide:database",
        "path": "/keyval",
        "priority": 80,
        "items": [
          { "title": "Overview", "icon": "lucide:home", "path": "/keyval" },
          { "title": "Entries", "icon": "lucide:list", "path": "/keyval/entries" }
        ]
      }
    ],
    "dependencies": ["@buntime/plugin-database"],
    "optionalDependencies": []
  },
  {
    "name": "@buntime/plugin-authn",
    "base": "/authn",
    "fragment": {
      "enabled": false
    },
    "menus": [],
    "dependencies": ["@buntime/plugin-database"],
    "optionalDependencies": []
  }
]
----

Estrutura de Plugin:

[cols="1,1,3"]
|===
| Campo | Tipo | Descrição

| `name`
| string
| Nome do plugin (package name)

| `base`
| string
| Base path das rotas do plugin

| `fragment.enabled`
| boolean
| Se o plugin tem interface visual

| `fragment.type`
| "patch" \| "iframe"
| Tipo de sandbox do fragment (opcional)

| `fragment.origin`
| string
| Origem para iframes (opcional)

| `fragment.preloadStyles`
| string
| CSS inline para injetar antes do load (opcional)

| `menus`
| MenuItem[]
| Items de navegação para sidebar

| `menus[].title`
| string
| Título do item de menu

| `menus[].icon`
| string
| Ícone (ex: `lucide:database`)

| `menus[].path`
| string
| Path de navegação

| `menus[].priority`
| number
| Prioridade de ordenação (menor = primeiro)

| `menus[].items`
| MenuItem[]
| Submenus aninhados (opcional)

| `dependencies`
| string[]
| Plugins obrigatórios

| `optionalDependencies`
| string[]
| Plugins opcionais
|===

== Worker Routes

Roteamento dinâmico para aplicações worker. Suporta versionamento semântico e descoberta automática de apps.

=== Formato de Apps

O runtime suporta dois formatos de diretório:

Flat (app@version):

[source]
----
apps/
  my-app@1.0.0/
  my-app@1.0.1/
  my-app@2.0.0/
----

Nested (app/version):

[source]
----
apps/
  my-app/
    1.0.0/
    1.0.1/
    2.0.0/
----

=== Resolução de Versões

O runtime usa semver para encontrar a versão correta:

[cols="1,2,2"]
|===
| Request | Descrição | Resolve para

| `/my-app/*`
| Versão mais recente
| `2.0.0`

| `/my-app@1/*`
| Versão mais recente 1.x.x
| `1.0.1`

| `/my-app@1.0/*`
| Versão mais recente 1.0.x
| `1.0.1`

| `/my-app@1.0.0/*`
| Versão exata
| `1.0.0`

| `/my-app@^1.0.0/*`
| Range semver
| `1.0.1`

| `/my-app@latest/*`
| Tag especial latest
| Diretório `my-app@latest` ou `my-app/latest`
|===

NOTE: Quando nenhuma versão é especificada (`/my-app/*`), o runtime prefere `latest` se existir, caso contrário usa a maior versão semver.

=== Entrypoints

O runtime busca entrypoints nesta ordem de prioridade:

1. `index.html` (servido como SPA estático)
2. `index.ts` (worker JavaScript)
3. `index.js` (worker JavaScript)
4. `index.mjs` (worker JavaScript)

Entrypoints podem ser customizados em `manifest.jsonc`:

[source,jsonc]
----
// manifest.jsonc
{
  "entrypoint": "server.ts"
}
----

=== ALL /:app/*

Roteia todas as requisições para uma aplicação worker.

Path Parameters:

[cols="1,1,3"]
|===
| Parâmetro | Tipo | Descrição

| `app`
| string
| Nome da aplicação com versão opcional
|===

Exemplos:

[source,bash]
----
# Versão mais recente
GET /my-app/users

# Versão específica
GET /my-app@1.0.0/users

# Range semver
GET /my-app@^1.0.0/users
----

Processo:

1. Verifica se é plugin app (rotas registradas por plugins)
2. Resolve versão nos workerDirs usando semver
3. Carrega worker config (`manifest.jsonc`)
4. Encontra entrypoint (HTML ou TS/JS)
5. Cria/reutiliza worker do pool
6. Injeta header `x-base` com base path (`/my-app`)
7. Encaminha requisição

Headers Especiais:

[cols="1,3"]
|===
| Header | Descrição

| `x-base`
| Base path injetado pelo runtime para assets (ex: `/my-app`)

| `x-fragment-route`
| Rota do fragment para modo app-shell (ex: `/metrics`)

| `x-buntime-internal`
| Marca request como interno (worker-to-runtime), bypassa CSRF

| `x-not-found`
| Indica que nenhum app foi encontrado, shell deve renderizar 404

| `x-request-id`
| ID único para correlação de requests (UUID)
|===

Resposta:

- Depende da aplicação worker
- Para SPAs (index.html): serve assets estáticos e fallback para index.html

=== GET /*

Rota fallback para a raiz (quando nenhuma outra rota corresponde).

Comportamento:

- Se `homepage` está configurado no runtime: roteia para app homepage
- Caso contrário: retorna texto `"Buntime v{version}"`

Exemplo com homepage:

[source,bash]
----
GET /
# Redireciona para homepage app configurado
----

Exemplo sem homepage:

[source,bash]
----
GET /
# Retorna: "Buntime v1.0.0"
----

=== Plugin Routes

Plugins registram rotas Hono no path base definido. Exemplo real do plugin-keyval:

*Manifesto (manifest.jsonc):*

[source,jsonc]
----
// plugins/plugin-keyval/manifest.jsonc
{
  "name": "@buntime/plugin-keyval",
  "base": "/keyval",
  "dependencies": ["@buntime/plugin-database"],
  "fragment": { "type": "patch" },
  "menus": [
    {
      "icon": "lucide:database",
      "path": "/keyval",
      "priority": 80,
      "title": "KeyVal",
      "items": [
        { "icon": "lucide:home", "path": "/keyval", "title": "Overview" },
        { "icon": "lucide:list", "path": "/keyval/entries", "title": "Entries" }
      ]
    }
  ]
}
----

*Implementação (plugin.ts):*

[source,typescript]
----
// plugins/plugin-keyval/plugin.ts
export default function keyvalExtension(config: KeyValConfig = {}): PluginImpl {
  return {
    routes: api,

    async onInit(ctx: PluginContext) {
      const database = ctx.getService<DatabaseService>("database");
      const kv = await initialize(database, { ... }, ctx.logger);
      ctx.registerService("kv", kv);
    },

    async onShutdown() {
      await shutdown();
    },
  };
}
----

Propriedades do `PluginManifest` (manifest.jsonc):

[cols="1,1,3"]
|===
| Propriedade | Tipo | Descrição

| `name`
| string
| Nome único do plugin (ex: `@buntime/plugin-keyval`)

| `base`
| string
| Path base para montar as rotas (ex: `/keyval`)

| `dependencies`
| string[]
| Plugins obrigatórios que devem ser carregados antes

| `optionalDependencies`
| string[]
| Plugins opcionais carregados antes se disponíveis

| `fragment`
| FragmentOptions
| Configuração de sandbox (`patch` ou `iframe`)

| `menus`
| MenuItem[]
| Items de menu com suporte a nested via `items`
|===

Propriedades do `PluginImpl` (plugin.ts):

[cols="1,1,3"]
|===
| Propriedade | Tipo | Descrição

| `routes`
| Hono
| App Hono montado em `/{base}/*`

| `middleware`
| MiddlewareHandler
| Alternativa ao `onRequest` como middleware Hono

| `server`
| PluginServer
| Rotas para `Bun.serve({ routes })` e fetch handler
|===

Lifecycle hooks:

[cols="1,2"]
|===
| Hook | Descrição

| `onInit(ctx)`
| Chamado na inicialização, recebe `PluginContext`

| `onShutdown()`
| Chamado no shutdown do buntime

| `onServerStart(server)`
| Chamado após `Bun.serve()`, recebe instância do servidor

| `onRequest(req, app?)`
| Intercepta requisições antes do worker

| `onResponse(res, app)`
| Modifica response antes de enviar ao cliente

| `onWorkerSpawn(worker, app)`
| Chamado quando worker é criado

| `onWorkerTerminate(worker, app)`
| Chamado quando worker é terminado
|===

== Core APIs

APIs internas do runtime para gerenciamento de plugins e apps. Estas APIs estão sempre disponíveis (resolvem o problema de bootstrap).

=== Plugins Core API

Base path: `/api/core/plugins`

Todas as operações em plugins individuais usam o `id` numérico do banco de dados.

==== Listagem

[cols="1,2,3"]
|===
| Método | Endpoint | Descrição

| GET
| `/api/core/plugins`
| Lista todos plugins instalados em `pluginDirs`

| GET
| `/api/core/plugins/:id`
| Retorna dados de um plugin específico
|===

==== Upload e Remoção

[cols="1,2,3"]
|===
| Método | Endpoint | Descrição

| POST
| `/api/core/plugins/upload`
| Upload de plugin (multipart/form-data, campo: `file`)

| DELETE
| `/api/core/plugins/:id`
| Remove plugin do filesystem e do database
|===

==== Versões

[cols="1,2,3"]
|===
| Método | Endpoint | Descrição

| GET
| `/api/core/plugins/:id/versions`
| Lista versões de um plugin

| PUT
| `/api/core/plugins/:id/version`
| Seleciona versão ativa (body: `{"version": "1.0.0"}`)
|===

==== Enable/Disable

[cols="1,2,3"]
|===
| Método | Endpoint | Descrição

| PUT
| `/api/core/plugins/:id/enable`
| Habilita um plugin

| PUT
| `/api/core/plugins/:id/disable`
| Desabilita um plugin
|===

==== Reload e Reset

[cols="1,2,3"]
|===
| Método | Endpoint | Descrição

| POST
| `/api/core/plugins/reload`
| Re-escaneia `pluginDirs` e recarrega todos os plugins

| POST
| `/api/core/plugins/:id/reload`
| Recarrega plugin específico

| POST
| `/api/core/plugins/reset`
| Remove todos plugins do DB e re-seed do manifest

| POST
| `/api/core/plugins/:id/reset`
| Remove plugin do DB e re-seed do manifest
|===

NOTE: **Reload** apenas re-escaneia o filesystem sem alterar o database. **Reset** remove o plugin do database e re-seed a partir do `manifest.jsonc`, restaurando valores padrão (o plugin receberá um novo `id`).

==== Resposta de Listagem

[source,json]
----
[
  {
    "id": 1,
    "name": "@buntime/plugin-keyval",
    "path": "/plugins/@buntime/plugin-keyval",
    "base": "/keyval",
    "enabled": true,
    "version": "latest",
    "config": { "database": "libsql" },
    "versions": ["1.0.0", "0.9.0"]
  }
]
----

=== Apps Core API

Base path: `/api/core/apps`

[cols="1,2,3"]
|===
| Método | Endpoint | Descrição

| GET
| `/api/core/apps`
| Lista apps instalados em `workerDirs`

| POST
| `/api/core/apps/upload`
| Upload de app (multipart/form-data, campo: `file`)

| DELETE
| `/api/core/apps/:scope/:name`
| Remove app (todas as versões)

| DELETE
| `/api/core/apps/:scope/:name/:version`
| Remove versão específica de app
|===

Resposta de listagem:

[source,json]
----
[
  {
    "name": "my-app",
    "path": "/apps/my-app",
    "versions": ["1.0.0", "latest"]
  }
]
----

NOTE: O upload aceita arquivos `.tgz`, `.tar.gz` ou `.zip`. O nome e versão são lidos do `package.json` interno.

=== Config Core API

Base path: `/api/core/config`

Gerenciamento de configurações dinâmicas do runtime armazenadas em SQLite (`buntime.db`).

[cols="1,2,3"]
|===
| Método | Endpoint | Descrição

| GET
| `/api/core/config/plugins`
| Lista todos plugins com versões ativas e configurações

| GET
| `/api/core/config/plugins/:name/version`
| Retorna versão ativa e versões disponíveis

| PUT
| `/api/core/config/plugins/:name/version`
| Define versão ativa (body: `{"version": "1.0.0"}`)

| DELETE
| `/api/core/config/plugins/:name/version`
| Reseta para "latest"

| GET
| `/api/core/config/plugins/:name/config`
| Retorna configurações do plugin

| PUT
| `/api/core/config/plugins/:name/config/:key`
| Define configuração (body: `{"value": "..."}`)

| DELETE
| `/api/core/config/plugins/:name/config/:key`
| Remove configuração específica

| DELETE
| `/api/core/config/plugins/:name/config`
| Remove todas configurações do plugin
|===

Resposta de listagem (`GET /api/core/config/plugins`):

[source,json]
----
{
  "versions": [
    {
      "name": "@buntime/plugin-keyval",
      "version": "1.0.0",
      "updatedAt": 1704067200
    }
  ],
  "configs": {
    "@buntime/plugin-keyval": {
      "metrics.flushInterval": "60000",
      "queue.cleanupInterval": "30000"
    }
  }
}
----

Resposta de versão (`GET /api/core/config/plugins/:name/version`):

[source,json]
----
{
  "name": "@buntime/plugin-keyval",
  "activeVersion": "1.0.0",
  "availableVersions": ["1.0.0", "0.9.0", "0.8.0"]
}
----

NOTE: Configurações do DB sobrescrevem valores do `manifest.jsonc`. Se não houver versão ativa definida, usa "latest" (maior semver).

== Arquitetura de Roteamento

Ordem de resolução de rotas (conforme implementado em `app.ts`):

1. **CSRF Protection** - Validação de Origin para requisições state-changing (POST, PUT, PATCH, DELETE)
2. **App-Shell Mode** - Intercepta navegação para shell se configurado (ver <<shell-routing>>)
3. **Plugin onRequest Hooks** - Executa hooks de autenticação e pré-processamento
4. **Plugins Core API** - `/api/core/plugins` (gerenciamento de plugins)
5. **Apps Core API** - `/api/core/apps` (gerenciamento de apps)
6. **Config Core API** - `/api/core/config` (configurações dinâmicas)
7. **Plugins Info API** - `/api/plugins` (informações sobre plugins carregados)
8. **Plugin server.fetch** - Handlers de requisição de plugins com `server.fetch`
9. **Plugin Routes** - Rotas Hono montadas por plugins (ex: `/keyval/*`, `/metrics/*`)
10. **Plugin Apps** - Apps de plugins servidos via worker pool (fragmentos)
11. **Worker Routes** - Apps nos workerDirs (ex: `/my-app/*`)
12. **404 with Shell** - Fallback para shell exibir página 404 consistente

NOTE: A ordem de prioridade garante que rotas mais específicas (plugins) sejam resolvidas antes de rotas genéricas (workers). Plugin Routes são ordenados por especificidade (paths mais longos primeiro).

[[shell-routing]]
=== Lógica de Shell Routing

A função `shouldRouteToShell()` determina se uma requisição deve ser interceptada pelo app-shell:

[cols="1,2"]
|===
| Condição | Comportamento

| `Sec-Fetch-Mode !== "navigate"`
| Rejeita - requests não-navegação (fetch, XMLHttpRequest) não são interceptados

| Path contém `/api/`
| Rejeita - rotas de API nunca vão para o shell

| Path é `/` ou vazio
| Aceita - homepage sempre vai para o shell

| Path corresponde a base de plugin
| Aceita - ex: `/metrics`, `/keyval/entries`
|===

O shell routing executa **após** os hooks `onRequest` dos plugins, permitindo que autenticação seja processada antes da decisão de roteamento.

=== Fallback para Homepage

Quando uma worker route retorna 404 e existe uma homepage configurada em modo inline (`base` definido), o runtime tenta servir o recurso a partir do app homepage:

[source]
----
GET /unknown-app/chunk-abc.js
  1. Worker route retorna 404
  2. Se homepage = { app: "/cpanel", base: "/" }
  3. Tenta buscar /cpanel/chunk-abc.js
  4. Se encontrado, retorna o asset
----

Isso permite que SPAs servidas na raiz carreguem assets corretamente mesmo quando acessadas por paths que não correspondem a apps específicos.

== Formato de Erros

Plugins retornam erros no formato:

[source,json]
----
{
  "error": "Mensagem de erro legível",
  "code": "ERROR_CODE"
}
----

NOTE: Consulte a documentação de cada plugin (`plugins/plugin-*/README.adoc`) para os códigos de erro específicos.
